<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Industry Benchmarks Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0b0f19;--bg2:#111827;--bg3:#1f2937;--bg4:#374151;
  --border:#1e293b;--border2:#334155;
  --text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
  --accent:#3b82f6;--accent2:#60a5fa;
  --green:#22c55e;--green2:#16a34a;--green-bg:rgba(34,197,94,.1);
  --orange:#f59e0b;--orange-bg:rgba(245,158,11,.1);
  --red:#ef4444;--red-bg:rgba(239,68,68,.1);
  --purple:#a78bfa;
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-variant-numeric:tabular-nums}
.topbar{position:sticky;top:0;z-index:100;background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.topbar h1{font-size:18px;font-weight:700;white-space:nowrap}
.main-tabs{display:flex;background:var(--bg);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.main-tab{padding:7px 18px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--text3);transition:all .15s}
.main-tab.active{background:var(--accent);color:#fff}
.main-tab:hover:not(.active){background:var(--bg3);color:var(--text2)}
.region-toggle{display:flex;background:var(--bg);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.region-btn{padding:7px 16px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--text3);transition:all .15s}
.region-btn.active{background:var(--accent);color:#fff}
.region-btn:hover:not(.active){background:var(--bg3);color:var(--text2)}
.search-wrap{flex:1;min-width:200px;max-width:400px;position:relative}
.search-wrap input{width:100%;padding:8px 12px 8px 36px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none}
.search-wrap input:focus{border-color:var(--accent)}
.search-wrap::before{content:'\1F50D';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;opacity:.5}
.stats{display:flex;gap:16px;font-size:12px;color:var(--text3);margin-left:auto}
.stats strong{color:var(--text2)}
.channel-bar{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.channel-bar-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-right:4px;font-weight:600}
.ch-group{display:flex;align-items:center;gap:2px;background:var(--bg);border-radius:8px;padding:3px;border:1px solid var(--border)}
.ch-group-btn{padding:5px 12px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;border:none;background:transparent;color:var(--text3);transition:all .15s;white-space:nowrap}
.ch-group-btn.active{background:var(--bg3);color:var(--text);border:1px solid var(--border2)}
.ch-group-btn:hover:not(.active){color:var(--text2)}
.ch-sub{display:flex;gap:4px;margin-left:4px;flex-wrap:wrap}
.ch-sub-btn{padding:3px 10px;border-radius:12px;font-size:11px;cursor:pointer;border:1px solid transparent;transition:all .15s;white-space:nowrap}
.ch-sub-btn.selected{border-color:rgba(255,255,255,.3);box-shadow:0 0 4px rgba(255,255,255,.1)}
.ch-sub-btn:hover{opacity:.8}
.loading{text-align:center;padding:80px;color:var(--text3)}
.spinner{display:inline-block;width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.main{padding:24px;max-width:1600px;margin:0 auto}
.super-cat{margin-bottom:28px}
.super-cat-hdr{display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;user-select:none}
.super-cat-hdr:hover h2{color:var(--accent2)}
.super-cat-hdr .arr{font-size:11px;color:var(--text3);transition:transform .2s;width:16px}
.super-cat-hdr.collapsed .arr{transform:rotate(-90deg)}
.super-cat-hdr h2{font-size:15px;font-weight:600}
.super-cat-hdr .cnt{font-size:11px;color:var(--text3);padding:2px 8px;background:var(--bg3);border-radius:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(580px,1fr));gap:16px}
.grid.hidden{display:none}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color .2s}
.card:hover{border-color:var(--border2)}
.card-top{padding:20px 24px 16px}
.card-top h3{font-size:17px;font-weight:700;margin-bottom:4px}
.card-top .card-channels{font-size:11px;color:var(--text3);margin-bottom:14px}
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.metric{background:var(--bg);border-radius:8px;padding:12px;text-align:center;border:1px solid var(--border)}
.metric .label{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:4px;font-weight:600}
.metric .val{font-size:22px;font-weight:800;line-height:1.1}
.metric .sub{font-size:10px;color:var(--text3);margin-top:3px}
.metric.highlight{border-color:var(--green);background:var(--green-bg)}
.metric.warn{border-color:var(--orange);background:var(--orange-bg)}
.metric.bad{border-color:var(--red);background:var(--red-bg)}
.spark-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:6px}
.spark-box{background:var(--bg);border-radius:8px;padding:10px 12px}
.spark-box .spark-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-bottom:4px}
.spark-box canvas{height:50px!important;width:100%!important}
.expand-btn{display:flex;align-items:center;justify-content:center;width:100%;padding:10px;background:none;border:none;border-top:1px solid var(--border);color:var(--text3);font-size:12px;cursor:pointer;transition:all .15s;font-weight:500}
.expand-btn:hover{color:var(--accent2);background:rgba(59,130,246,.05)}
.detail{display:none;padding:20px 24px;border-top:1px solid var(--border);background:var(--bg)}
.detail.open{display:block}
.detail h4{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.detail-section{margin-bottom:20px}
.tbl{width:100%;border-collapse:collapse;font-size:12px;display:block;overflow-x:auto}
.tbl th,.tbl td{padding:6px 8px;text-align:right;white-space:nowrap}
.tbl th{color:var(--text3);font-weight:500;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg)}
.tbl td:first-child,.tbl th:first-child{text-align:left}
.tbl tr:hover td{background:var(--bg2)}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.chart-box{background:var(--bg2);border-radius:8px;padding:14px}
.chart-box h5{font-size:11px;color:var(--text3);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.chart-box canvas{width:100%!important;height:170px!important}
.no-us{display:inline-block;padding:2px 8px;font-size:10px;background:var(--bg3);color:var(--text3);border-radius:4px;margin-left:8px}

/* === META ADS TAB STYLES === */
.meta-nav{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;gap:4px;flex-wrap:wrap;align-items:center}
.meta-nav-btn{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;background:transparent;color:var(--text3);transition:all .15s}
.meta-nav-btn.active{background:var(--bg3);color:var(--text);border-color:var(--border2)}
.meta-nav-btn:hover:not(.active){color:var(--text2);background:var(--bg3)}
.meta-main{padding:24px;max-width:1600px;margin:0 auto}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:28px}
.kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center}
.kpi-card .kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:6px;font-weight:600}
.kpi-card .kpi-val{font-size:28px;font-weight:800;margin-bottom:4px}
.kpi-card .kpi-sub{font-size:11px;color:var(--text3)}
.kpi-card .kpi-range{font-size:10px;color:var(--text3);margin-top:4px}
.sources-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.src-badge{padding:4px 12px;border-radius:14px;font-size:11px;font-weight:600;border:1px solid var(--border);color:var(--text2)}
.data-tbl{width:100%;border-collapse:collapse;font-size:13px}
.data-tbl th{padding:10px 12px;text-align:left;color:var(--text3);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap}
.data-tbl th:hover{color:var(--accent2)}
.data-tbl th.sorted-asc::after{content:' \2191';color:var(--accent)}
.data-tbl th.sorted-desc::after{content:' \2193';color:var(--accent)}
.data-tbl td{padding:8px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
.data-tbl tr:hover td{background:var(--bg3)}
.data-tbl td.num{text-align:right;font-variant-numeric:tabular-nums;font-weight:500}
.data-tbl .src-tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;margin-left:4px}
.section-title{font-size:16px;font-weight:700;margin-bottom:16px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.meta-chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
.meta-chart-box{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:20px}
.meta-chart-box.wide{grid-column:1/-1}
.meta-chart-box h5{font-size:12px;color:var(--text3);margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.meta-chart-box canvas{width:100%!important;height:250px!important}
.meta-search{margin-bottom:16px}
.meta-search input{width:100%;max-width:400px;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none}
.meta-search input:focus{border-color:var(--accent)}
.insight-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;margin-bottom:28px}
.insight{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px}
.insight h6{font-size:11px;text-transform:uppercase;color:var(--text3);letter-spacing:.5px;margin-bottom:6px;font-weight:600}
.insight .val{font-size:18px;font-weight:700;margin-bottom:4px}
.insight .desc{font-size:12px;color:var(--text3)}

/* =============================================
   SPACIOUS INDUSTRY SECTIONS — NEW UI
   ============================================= */
.meta-sub-controls{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.view-toggle{display:flex;background:var(--bg);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.view-toggle-btn{padding:6px 16px;font-size:12px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--text3);transition:all .15s}
.view-toggle-btn.active{background:var(--accent);color:#fff}
.view-toggle-btn:hover:not(.active){background:var(--bg3);color:var(--text2)}
.source-pills{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.source-pills-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-right:4px}
.source-pill{padding:5px 14px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:2px solid transparent;transition:all .2s;user-select:none}
.source-pill.active{opacity:1}
.source-pill:not(.active){opacity:.35;filter:grayscale(.5)}
.source-pill:hover{opacity:.85}

/* Industry Section (full-width panel) */
.ind-section{background:var(--bg2);border:1px solid var(--border);border-radius:16px;margin-bottom:24px;overflow:hidden;transition:border-color .25s ease,box-shadow .25s ease}
.ind-section:hover{border-color:var(--border2);box-shadow:0 0 30px rgba(59,130,246,.04)}
.ind-header{padding:24px 28px 0;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.ind-name{font-size:22px;font-weight:800;letter-spacing:-.3px}
.source-count-badge{padding:3px 10px;border-radius:12px;font-size:11px;font-weight:700;background:var(--bg3);color:var(--text2)}
.agreement-meter{height:6px;width:120px;border-radius:3px;background:var(--bg);overflow:hidden;position:relative}
.agreement-meter-fill{height:100%;border-radius:3px;transition:width .3s ease}
.agreement-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.4px}
.ind-source-badges{padding:8px 28px 0;display:flex;gap:6px;flex-wrap:wrap}
.ind-src-pill{padding:3px 10px;border-radius:10px;font-size:10px;font-weight:600}
.geo-tag{display:inline-block;padding:1px 5px;border-radius:4px;font-size:8px;font-weight:700;letter-spacing:.3px;margin-left:3px;vertical-align:middle}

/* Consensus KPI Row */
.consensus-kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:14px;padding:20px 28px}
.ckpi{background:var(--bg);border-radius:12px;padding:16px;text-align:center;border:1px solid var(--border);position:relative;transition:border-color .2s}
.ckpi:hover{border-color:var(--border2)}
.ckpi-label{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);margin-bottom:6px;font-weight:700}
.ckpi-value{font-size:28px;font-weight:800;line-height:1.1;margin-bottom:6px}
.ckpi-ci-bar{height:4px;border-radius:2px;margin:0 8px 6px;overflow:hidden;background:var(--bg3)}
.ckpi-ci-fill{height:100%;border-radius:2px;transition:width .3s ease}
.ckpi-ci-text{font-size:10px;color:var(--text3);margin-bottom:4px}
.ckpi-sources{font-size:10px;color:var(--text3)}
.ckpi-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:4px;vertical-align:middle}
.ckpi.single-source{border-style:dashed}

/* Source Breakdown (expandable) */
.ind-expand-btn{display:flex;align-items:center;justify-content:center;width:100%;padding:12px;background:none;border:none;border-top:1px solid var(--border);color:var(--text3);font-size:12px;cursor:pointer;transition:all .2s;font-weight:600;gap:6px}
.ind-expand-btn:hover{color:var(--accent2);background:rgba(59,130,246,.04)}
.source-breakdown{max-height:0;overflow:hidden;transition:max-height .35s ease,padding .25s ease;border-top:0 solid var(--border)}
.source-breakdown.open{max-height:2000px;padding:20px 28px;border-top-width:1px}
.src-breakdown-tbl{width:100%;border-collapse:collapse;font-size:13px}
.src-breakdown-tbl th{padding:8px 10px;text-align:right;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:600;border-bottom:1px solid var(--border)}
.src-breakdown-tbl th:first-child{text-align:left}
.src-breakdown-tbl td{padding:8px 10px;text-align:right;border-bottom:1px solid rgba(30,41,59,.5)}
.src-breakdown-tbl td:first-child{text-align:left}
.src-breakdown-tbl tr:hover td{background:var(--bg3)}
.dev-positive{color:var(--red)}
.dev-negative{color:var(--green)}
.dev-neutral{color:var(--text3)}
.outlier-flag{display:inline-block;padding:1px 5px;font-size:9px;font-weight:700;border-radius:3px;background:var(--red-bg);color:var(--red);margin-left:4px}

/* Range visualization in breakdown */
.range-viz{position:relative;height:12px;background:var(--bg3);border-radius:6px;margin:4px 0;min-width:160px}
.range-viz-fill{position:absolute;height:100%;background:var(--accent);opacity:.3;border-radius:6px}
.range-viz-marker{position:absolute;width:3px;height:100%;border-radius:2px;top:0}
.range-viz-consensus{position:absolute;width:2px;height:16px;top:-2px;background:var(--text);border-radius:1px}

/* Comparison Mode Table */
.comparison-tbl{width:100%;border-collapse:collapse;font-size:13px;margin:20px 0}
.comparison-tbl th{padding:10px 12px;text-align:right;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:600;border-bottom:2px solid var(--border)}
.comparison-tbl th:first-child{text-align:left}
.comparison-tbl td{padding:8px 12px;text-align:right;border-bottom:1px solid rgba(30,41,59,.5)}
.comparison-tbl td:first-child{text-align:left}
.comparison-tbl tr:last-child td{border-top:2px solid var(--border);font-weight:700}
.comparison-tbl tr:hover td{background:var(--bg3)}
.dev-cell{border-radius:4px;padding:2px 4px}
.dev-cell.hot{background:rgba(239,68,68,.12)}
.dev-cell.warm{background:rgba(245,158,11,.1)}
.dev-cell.cool{background:rgba(34,197,94,.1)}

/* Country Section */
.ctry-section{background:var(--bg2);border:1px solid var(--border);border-radius:16px;margin-bottom:20px;overflow:hidden;transition:border-color .25s ease,box-shadow .25s ease}
.ctry-section:hover{border-color:var(--border2);box-shadow:0 0 20px rgba(59,130,246,.03)}
.ctry-header{padding:20px 24px 0;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.ctry-name{font-size:20px;font-weight:800;letter-spacing:-.2px}
.ctry-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:16px 24px 20px}
.ctry-expand-btn{display:flex;align-items:center;justify-content:center;width:100%;padding:10px;background:none;border:none;border-top:1px solid var(--border);color:var(--text3);font-size:12px;cursor:pointer;transition:all .2s;font-weight:600;gap:6px}
.ctry-expand-btn:hover{color:var(--accent2);background:rgba(59,130,246,.04)}
.ctry-breakdown{max-height:0;overflow:hidden;transition:max-height .35s ease,padding .25s ease;border-top:0 solid var(--border)}
.ctry-breakdown.open{max-height:1000px;padding:16px 24px;border-top-width:1px}

/* Badge for data quality */
.data-badge{display:inline-block;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:.3px}
.data-badge.single{background:rgba(59,130,246,.15);color:var(--accent2)}
.data-badge.limited{background:rgba(245,158,11,.15);color:var(--orange)}
.data-badge.good{background:rgba(34,197,94,.12);color:var(--green)}

@media(max-width:1024px){
  .consensus-kpis{grid-template-columns:repeat(3,1fr)}
  .ctry-kpis{grid-template-columns:repeat(3,1fr)}
}
@media(max-width:768px){
  .grid{grid-template-columns:1fr}
  .metrics{grid-template-columns:repeat(2,1fr)}
  .chart-row,.meta-chart-grid{grid-template-columns:1fr}
  .topbar{padding:10px 16px}
  .channel-bar,.meta-nav{padding:8px 16px}
  .main,.meta-main{padding:16px}
  .stats{display:none}
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .meta-chart-box.wide{grid-column:auto}
  .consensus-kpis{grid-template-columns:repeat(2,1fr)}
  .ctry-kpis{grid-template-columns:1fr 1fr 1fr}
  .ind-header{padding:16px 16px 0}
  .ind-source-badges{padding:6px 16px 0}
  .consensus-kpis{padding:14px 16px}
  .source-breakdown.open{padding:14px 16px}
  .ind-name{font-size:18px}
  .ckpi-value{font-size:22px}
}
@media(max-width:480px){
  .consensus-kpis{grid-template-columns:1fr}
  .ctry-kpis{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="topbar">
  <h1>Industry Benchmarks</h1>
  <div class="main-tabs" id="mainTabs">
    <button class="main-tab active" data-tab="tw">Multi-Channel</button>
    <button class="main-tab" data-tab="meta">Meta Ads</button>
  </div>
  <div id="twControls" style="display:contents">
    <div class="region-toggle" id="regionToggle">
      <button class="region-btn active" data-region="global">All Markets</button>
      <button class="region-btn" data-region="us">$1M-$10M GMV</button>
    </div>
    <div class="search-wrap"><input type="text" id="searchInput" placeholder="Search industries..."></div>
    <div class="stats">
      <span><strong id="sI">0</strong> Industries</span>
      <span><strong id="sC">0</strong> Channels</span>
      <span><strong id="sR">0</strong> Records</span>
    </div>
  </div>
</div>

<!-- ===== TRIPLE WHALE VIEW ===== -->
<div id="twView">
  <div class="channel-bar">
    <span class="channel-bar-label">Channels:</span>
    <div class="ch-group" id="chGroupBar">
      <button class="ch-group-btn active" data-group="all">All</button>
      <button class="ch-group-btn" data-group="social">Social</button>
      <button class="ch-group-btn" data-group="search">Search</button>
      <button class="ch-group-btn" data-group="native">Native</button>
      <button class="ch-group-btn" data-group="marketplace">Marketplace</button>
      <button class="ch-group-btn" data-group="other">Other</button>
    </div>
    <div class="ch-sub" id="chSubBar"></div>
    <span style="margin-left:auto" class="data-badge single">Single Source: Triple Whale</span>
  </div>
  <div class="loading" id="loading"><div class="spinner"></div><div>Loading benchmarks...</div></div>
  <div class="main" id="main" style="display:none"></div>
</div>

<!-- ===== META ADS VIEW ===== -->
<div id="metaView" style="display:none">
  <div class="meta-nav" id="metaNav">
    <button class="meta-nav-btn active" data-meta="overview">Overview</button>
    <button class="meta-nav-btn" data-meta="industry">By Industry</button>
    <button class="meta-nav-btn" data-meta="country">By Country</button>
    <button class="meta-nav-btn" data-meta="trends">Weekly Trends</button>
    <button class="meta-nav-btn" data-meta="objectives">Objectives & Placements</button>
    <a href="https://bogdanalra.github.io/benchmarks-methodology/" target="_blank" style="margin-left:auto;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;color:var(--text3);border:1px solid var(--border);text-decoration:none;transition:all .15s" onmouseover="this.style.color='var(--accent2)';this.style.borderColor='var(--accent)'" onmouseout="this.style.color='var(--text3)';this.style.borderColor='var(--border)'">Methodology &rarr;</a>
  </div>
  <div class="meta-sub-controls" id="metaSubControls" style="display:none">
    <div class="view-toggle" id="viewToggle">
      <button class="view-toggle-btn active" data-mode="consensus">Consensus</button>
      <button class="view-toggle-btn" data-mode="comparison">Source Comparison</button>
    </div>
    <div class="source-pills" id="sourcePills">
      <span class="source-pills-label">Sources:</span>
    </div>
    <div class="search-wrap" style="min-width:160px;max-width:300px"><input type="text" id="metaSearchInput" placeholder="Search..."></div>
  </div>
  <div class="meta-main" id="metaMain"></div>
</div>

<script>
// =============================================
// STATISTICAL RECONCILIATION ENGINE (StatEngine)
// =============================================
const StatEngine = {
  WEIGHTS: {
    'Superads': 0.85,
    'Revealbot': 0.80,
    'Databox': 0.75,
    'Vaizle': 0.70,
    'Madgicx': 0.65,
    'WordStream': 0.60,
    'WS Leads': 0.55,
    'ADCostly+': 0.40
  },

  // =========================================
  // TEMPORAL ADJUSTMENT (Nowcasting)
  // Uses Revealbot monthly series as time-series anchor.
  // Sources collected in earlier months are scaled to
  // current (Feb 2026) using the Revealbot CPM/CPC index.
  // Index(t) = Revealbot(latest) / Revealbot(t_collection)
  // =========================================
  SOURCE_COLLECTION_MONTH: {
    // Index into RB_MONTHS (0=Feb25 ... 12=Feb26)
    'Superads': 10,    // ~Dec 2025 ($3B spend data)
    'Revealbot': 12,   // Feb 2026 (latest, anchor)
    'Databox': 9,      // ~Nov 2025 (monthly reports)
    'Vaizle': 6,       // Aug 2025 (5,200 accounts)
    'Madgicx': 8,      // ~Oct 2025
    'WordStream': 5,   // ~Jul 2025
    'WS Leads': 5,     // ~Jul 2025
    'ADCostly+': 4     // ~Jun 2025 (composite older data)
  },

  // Compute temporal adjustment factor for a source
  temporalFactor(source, metric) {
    const idx = this.SOURCE_COLLECTION_MONTH[source];
    if (idx == null || idx === 12) return 1.0; // already current or unknown
    // Use CPM series for cpm/cpa, CPC series for cpc
    const series = (metric === 'cpc') ? RB_FB_CPC : RB_FB_CPM;
    const latest = series[12]; // Feb 2026
    const atCollection = series[idx];
    if (!atCollection || atCollection === 0) return 1.0;
    // Clamp factor to [0.7, 1.5] to avoid extreme adjustments
    return Math.max(0.7, Math.min(1.5, latest / atCollection));
  },

  // Apply temporal adjustment to a value
  temporalAdjust(value, source, metric) {
    if (value == null) return value;
    // Only adjust cost metrics (cpm, cpc, cpa) — ratios (ctr, cvr, roas) are more stable
    if (!['cpm', 'cpc', 'cpa'].includes(metric)) return value;
    return value * this.temporalFactor(source, metric);
  },

  // =========================================
  // GEOGRAPHIC CORRECTION
  // Adjusts Global sources toward US estimates using
  // the US/Global CPM ratio derived from ADCostly+ country data.
  // Databox is handled specially as 70% US / 30% international.
  // =========================================
  // US/Global CPM ratio derived from country data:
  // US CPM ~$22.20 (Superads), global average CPM ~$11.50
  // → US is ~1.93x global average for CPM
  // For CPC: US CPC ~$1.11, global avg ~$0.85 → 1.31x
  GEO_RATIOS: {
    cpm: { us_to_global: 1.93, global_to_us: 1.93 },
    cpc: { us_to_global: 1.31, global_to_us: 1.31 },
    cpa: { us_to_global: 1.50, global_to_us: 1.50 },  // estimated
    ctr: { us_to_global: 1.0, global_to_us: 1.0 },     // CTR is relatively stable across geos
    cvr: { us_to_global: 1.0, global_to_us: 1.0 },
    roas: { us_to_global: 1.0, global_to_us: 1.0 }
  },

  // Source geographic composition: fraction of data that is US
  SRC_US_FRACTION: {
    'Superads': 0.35,   // Global, ~35% US ad spend share
    'Vaizle': 0.40,     // Global, India/US-heavy
    'WordStream': 1.0,  // US only
    'WS Leads': 1.0,    // US only
    'Databox': 0.70,    // 70% US / 30% international
    'Madgicx': 0.45,    // Global, e-commerce skew
    'ADCostly+': 0.30,  // Global, broad coverage
    'Revealbot': 1.0    // US only
  },

  // Compute geographic adjustment to estimate US-equivalent value
  geoAdjust(value, source, metric) {
    if (value == null) return value;
    const usFrac = this.SRC_US_FRACTION[source];
    if (usFrac == null || usFrac >= 0.95) return value; // already US-only
    const ratio = this.GEO_RATIOS[metric];
    if (!ratio || ratio.global_to_us === 1.0) return value;
    // Mixed source decomposition:
    // observed = usFrac * μ_US + (1-usFrac) * μ_intl
    // where μ_intl ≈ μ_US / ratio
    // → observed = usFrac * μ_US + (1-usFrac) * μ_US / ratio
    // → μ_US = observed / (usFrac + (1-usFrac) / ratio)
    const intlFrac = 1.0 - usFrac;
    const denominator = usFrac + intlFrac / ratio.global_to_us;
    if (denominator === 0) return value;
    const usEstimate = value / denominator;
    // Blend: don't fully correct, apply 60% of the correction to avoid over-adjusting
    const correction = 0.6;
    return value + correction * (usEstimate - value);
  },

  // =========================================
  // JAMES-STEIN SHRINKAGE
  // For sparse industries (few sources), shrink estimates
  // toward the grand mean across all industries.
  // θ_shrunk = grandMean + c·(θ_i - grandMean)
  // where c = max(0, 1 - (k-2)·σ² / Σ(θ_i - grandMean)²)
  // k = number of industries (dimensions)
  // Provably dominates MLE for k ≥ 3 (Stein 1956)
  // =========================================
  _grandMeans: {}, // populated during batch processing

  computeGrandMean(allIndustries, metricKey) {
    const vals = [];
    const wts = [];
    for (const [, consensus] of Object.entries(allIndustries)) {
      const d = consensus[metricKey];
      if (d && d.value != null && d.sources.length >= 2) {
        vals.push(d.value);
        wts.push(d.sources.length); // weight by source count
      }
    }
    if (vals.length === 0) return null;
    let sumWV = 0, sumW = 0;
    for (let i = 0; i < vals.length; i++) { sumWV += vals[i] * wts[i]; sumW += wts[i]; }
    return sumWV / sumW;
  },

  jamesSteingShrink(value, grandMean, allValues, sourceCount) {
    if (value == null || grandMean == null) return value;
    if (sourceCount >= 4) return value; // enough data, no shrinkage needed
    const k = allValues.length;
    if (k < 3) return value; // JS needs k≥3
    // Compute sum of squared deviations from grand mean
    let sumSqDev = 0;
    for (const v of allValues) sumSqDev += Math.pow(v - grandMean, 2);
    if (sumSqDev === 0) return value;
    // Estimate σ² as average squared deviation
    const sigma2 = sumSqDev / k;
    // Shrinkage factor: c = max(0, 1 - (k-2)·σ² / sumSqDev)
    const c = Math.max(0, 1 - ((k - 2) * sigma2) / sumSqDev);
    // For sparse industries (1-2 sources), apply stronger shrinkage
    const sparsityBoost = sourceCount <= 1 ? 0.5 : sourceCount <= 2 ? 0.7 : 0.85;
    const effectiveC = c * sparsityBoost;
    return grandMean + effectiveC * (value - grandMean);
  },

  // =========================================
  // CPM = CPC × CTR × 1000 CONSISTENCY CHECK
  // Cross-validates metrics using algebraic identity.
  // When 2 of 3 are present, imputes the missing one.
  // Flags violations beyond 15% threshold.
  // =========================================
  checkCPMConsistency(cpm, cpc, ctr) {
    // ctr is in percentage points (e.g., 2.0 = 2%)
    const result = { consistent: null, impliedCPM: null, impliedCPC: null, impliedCTR: null, violation: null };
    if (cpc != null && ctr != null && ctr > 0) {
      result.impliedCPM = cpc * (ctr / 100) * 1000;
      if (cpm != null) {
        const pctDiff = Math.abs(cpm - result.impliedCPM) / Math.max(cpm, result.impliedCPM);
        result.consistent = pctDiff < 0.15;
        result.violation = pctDiff;
      }
    }
    if (cpm != null && ctr != null && ctr > 0) {
      result.impliedCPC = cpm / ((ctr / 100) * 1000);
    }
    if (cpm != null && cpc != null && cpc > 0) {
      result.impliedCTR = (cpm / (cpc * 1000)) * 100;
    }
    return result;
  },

  // Apply consistency-based imputation to a row
  imputeFromConsistency(row) {
    const check = this.checkCPMConsistency(row.cpm, row.cpc, row.ctr);
    const patched = { ...row, _consistency: check };
    // Impute missing values from available ones
    if (patched.cpm == null && check.impliedCPM != null) {
      patched.cpm = check.impliedCPM;
      patched._cpmImputed = true;
    }
    if (patched.cpc == null && check.impliedCPC != null) {
      patched.cpc = check.impliedCPC;
      patched._cpcImputed = true;
    }
    if (patched.ctr == null && check.impliedCTR != null && check.impliedCTR > 0 && check.impliedCTR < 20) {
      patched.ctr = check.impliedCTR;
      patched._ctrImputed = true;
    }
    return patched;
  },

  // =========================================
  // CORE FUNCTIONS
  // =========================================
  computeWeightedMean(values, weights) {
    let sumWV = 0, sumW = 0;
    for (let i = 0; i < values.length; i++) {
      sumWV += values[i] * weights[i];
      sumW += weights[i];
    }
    return sumW > 0 ? sumWV / sumW : null;
  },

  computeWeightedCI(values, weights, consensus) {
    const n = values.length;
    if (n < 2) return null;
    let sumW = 0, sumW2 = 0, sumWD2 = 0;
    for (let i = 0; i < n; i++) {
      sumW += weights[i];
      sumW2 += weights[i] * weights[i];
      sumWD2 += weights[i] * Math.pow(values[i] - consensus, 2);
    }
    const denom = sumW - sumW2 / sumW;
    if (denom <= 0) return null;
    const wVar = sumWD2 / denom;
    const wSD = Math.sqrt(wVar);
    const nEff = (sumW * sumW) / sumW2;
    const se = wSD / Math.sqrt(nEff);
    return { low: consensus - 1.96 * se, high: consensus + 1.96 * se, sd: wSD };
  },

  computeDisagreement(values, consensus) {
    if (values.length < 2) return 'single';
    if (consensus === 0) return 'agreement';
    const maxDev = Math.max(...values.map(v => Math.abs(v - consensus) / Math.abs(consensus)));
    if (maxDev < 0.10) return 'agreement';
    if (maxDev < 0.20) return 'moderate';
    if (maxDev < 0.50) return 'disagreement';
    return 'conflict';
  },

  identifyOutliers(values, weights, consensus) {
    if (values.length < 3) return values.map(() => false);
    let sumW = 0, sumWD2 = 0;
    for (let i = 0; i < values.length; i++) {
      sumW += weights[i];
      sumWD2 += weights[i] * Math.pow(values[i] - consensus, 2);
    }
    const wSD = Math.sqrt(sumWD2 / sumW);
    if (wSD === 0) return values.map(() => false);
    return values.map(v => Math.abs(v - consensus) > 2 * wSD);
  },

  // =========================================
  // ENHANCED CONSENSUS (full pipeline)
  // Pipeline: Impute → Temporal → Geographic → IVW → Shrinkage
  // =========================================
  computeConsensus(rows, metricKeys, opts = {}) {
    const result = {};
    // Step 1: Apply CPM=CPC×CTR consistency imputation
    const enrichedRows = rows.map(r => this.imputeFromConsistency(r));

    for (const m of metricKeys) {
      const pairs = enrichedRows.filter(r => r[m] != null).map(r => ({
        value: r[m],
        rawValue: r[m], // preserve original
        source: r.source,
        weight: this.WEIGHTS[r.source] || 0.50,
        imputed: r['_' + m + 'Imputed'] || false
      }));
      if (pairs.length === 0) {
        result[m] = { value: null, ci_low: null, ci_high: null, disagreement: 'none', sources: [], adjustments: null };
        continue;
      }

      // Step 2: Apply temporal adjustment
      const temporalFactors = {};
      for (const p of pairs) {
        const factor = this.temporalFactor(p.source, m);
        p.value = this.temporalAdjust(p.rawValue, p.source, m);
        temporalFactors[p.source] = factor;
        // Reduce weight for imputed values
        if (p.imputed) p.weight *= 0.6;
      }

      // Step 3: Apply geographic correction (if US-focused view)
      const geoFactors = {};
      if (opts.geoTarget !== 'global') {
        for (const p of pairs) {
          const before = p.value;
          p.value = this.geoAdjust(p.value, p.source, m);
          geoFactors[p.source] = before !== 0 ? p.value / before : 1.0;
        }
      }

      // Step 4: IVW consensus
      const values = pairs.map(p => p.value);
      const weights = pairs.map(p => p.weight);
      const consensus = this.computeWeightedMean(values, weights);
      const ci = pairs.length >= 2 ? this.computeWeightedCI(values, weights, consensus) : null;
      const disagreement = this.computeDisagreement(values, consensus);
      const outliers = this.identifyOutliers(values, weights, consensus);

      result[m] = {
        value: consensus,
        ci_low: ci ? Math.max(0, ci.low) : consensus,
        ci_high: ci ? ci.high : consensus,
        sd: ci ? ci.sd : 0,
        disagreement,
        sources: pairs.map((p, i) => ({
          name: p.source,
          value: p.value,
          rawValue: p.rawValue,
          weight: p.weight,
          deviation: consensus !== 0 ? ((p.value - consensus) / Math.abs(consensus) * 100) : 0,
          isOutlier: outliers[i],
          imputed: p.imputed,
          temporalFactor: temporalFactors[p.source] || 1.0,
          geoFactor: geoFactors[p.source] || 1.0
        })),
        adjustments: {
          temporalApplied: Object.values(temporalFactors).some(f => f !== 1.0),
          geoApplied: Object.keys(geoFactors).length > 0,
          imputedCount: pairs.filter(p => p.imputed).length
        }
      };
    }
    return result;
  },

  // Step 5: Apply James-Stein shrinkage across all industries (post-processing)
  applyShrinkage(allIndustries, metricKeys) {
    for (const m of metricKeys) {
      // Collect all consensus values for this metric
      const allVals = [];
      for (const [, consensus] of Object.entries(allIndustries)) {
        if (consensus[m] && consensus[m].value != null) allVals.push(consensus[m].value);
      }
      if (allVals.length < 3) continue;
      const grandMean = this.computeGrandMean(allIndustries, m);
      if (grandMean == null) continue;
      this._grandMeans[m] = grandMean;

      for (const [, consensus] of Object.entries(allIndustries)) {
        const d = consensus[m];
        if (!d || d.value == null) continue;
        const srcCount = d.sources.length;
        if (srcCount >= 4) continue; // enough data, skip shrinkage
        const original = d.value;
        d.value = this.jamesSteingShrink(original, grandMean, allVals, srcCount);
        d._shrunk = original !== d.value;
        d._preShrink = original;
        // Also adjust CI bounds proportionally
        if (d._shrunk && original !== 0) {
          const ratio = d.value / original;
          d.ci_low = Math.max(0, d.ci_low * ratio);
          d.ci_high = d.ci_high * ratio;
        }
      }
    }
    return allIndustries;
  },

  // Console helper for debugging
  validate() {
    console.log('=== StatEngine Validation (Enhanced) ===');
    // Real Estate CPM test
    const reRows = [];
    for (const row of MI) {
      if ((ALIAS_INDEX[row[0]] || row[0]) === 'Real Estate' && row[2] != null) {
        reRows.push({ source: row[1], cpm: row[2], cpc: row[3], ctr: row[4] });
      }
    }
    console.log('Real Estate CPM sources:', reRows.map(r => `${r.source}: $${r.cpm}`));
    const vals = reRows.map(r => r.cpm);
    const wts = reRows.map(r => StatEngine.WEIGHTS[r.source] || 0.5);
    const mean = StatEngine.computeWeightedMean(vals, wts);
    console.log('Raw IVW Mean: $' + mean.toFixed(2));

    // Temporal factors
    console.log('\n--- Temporal Adjustment Factors ---');
    for (const src of Object.keys(this.WEIGHTS)) {
      const f = this.temporalFactor(src, 'cpm');
      if (f !== 1.0) console.log(`  ${src}: ×${f.toFixed(3)}`);
    }

    // Geo factors
    console.log('\n--- Geographic Correction (US estimate) ---');
    for (const src of Object.keys(this.WEIGHTS)) {
      const usFrac = this.SRC_US_FRACTION[src];
      if (usFrac < 0.95) console.log(`  ${src}: ${(usFrac*100).toFixed(0)}% US → adjust ×${(this.geoAdjust(10, src, 'cpm')/10).toFixed(3)}`);
    }

    // Consistency check
    console.log('\n--- CPM=CPC×CTR Consistency ---');
    let violations = 0;
    for (const row of reRows) {
      const check = this.checkCPMConsistency(row.cpm, row.cpc, row.ctr);
      if (check.violation != null) {
        const status = check.consistent ? 'OK' : 'VIOLATION';
        console.log(`  ${row.source}: CPM=$${row.cpm} vs implied=$${check.impliedCPM?.toFixed(2)} (${(check.violation*100).toFixed(1)}% diff) [${status}]`);
        if (!check.consistent) violations++;
      }
    }

    // James-Stein
    console.log('\n--- James-Stein Shrinkage ---');
    const grandCPM = this._grandMeans?.cpm;
    if (grandCPM) console.log(`  Grand mean CPM: $${grandCPM.toFixed(2)}`);
    let shrunkCount = 0;
    for (const [ind, c] of Object.entries(normalizedIndustries)) {
      if (c.cpm?._shrunk) {
        console.log(`  ${ind}: $${c.cpm._preShrink.toFixed(2)} → $${c.cpm.value.toFixed(2)} (${c.cpm.sources.length} sources)`);
        shrunkCount++;
      }
    }
    console.log(`  ${shrunkCount} industries shrunk toward grand mean`);

    console.log('\n--- Summary ---');
    console.log('Canonical industries:', Object.keys(normalizedIndustries).length);
    console.log('Canonical countries:', Object.keys(normalizedCountries).length);
    console.log('Total MI rows:', MI.length, '| Mapped:', Object.values(normalizedIndustries).reduce((s, d) => s + d._rows.length, 0));
    console.log('Consistency violations:', violations);
    return { mean, grandMeans: this._grandMeans };
  }
};

// =============================================
// INDUSTRY NAME MAPPING (~40 canonical names)
// =============================================
const INDUSTRY_MAP = {
  'Agriculture':['Agriculture'],
  'Animals & Pets':['Animals & Pets'],
  'Arts & Entertainment':['Arts','Arts & Entertainment'],
  'Automotive':['Automotive'],
  'Beauty & Personal Care':['Beauty & Personal Care','Beauty & Cosmetics'],
  'Business Services':['Business Services','Consulting'],
  'Career & Employment':['Career & Employment','HR & Staffing'],
  'Construction':['Construction'],
  'Consumer Goods':['Consumer Goods'],
  'Crypto & Blockchain':['Crypto & Blockchain'],
  'Dentists & Dental':['Dentists'],
  'Design':['Design'],
  'E-commerce':['E-commerce','Marketplaces'],
  'Education':['Education'],
  'Energy & Mining':['Energy & Mining'],
  'Fashion & Apparel':['Fashion & Apparel','Apparel & Fashion','Apparel & Footwear','Textiles'],
  'Finance & Insurance':['Finance','Finance & Insurance'],
  'Food & Beverage':['Food & Beverage','Restaurants & Food','Food & Restaurants','Wine & Spirits'],
  'Furniture':['Furniture'],
  'Gaming':['Gaming'],
  'Hardware & Networking':['Hardware & Networking'],
  'Health & Wellness':['Health & Wellness','Health & Fitness','Fitness & Training','Wellness','Sports & Fitness'],
  'Healthcare':['Healthcare'],
  'Home Improvement':['Home Improvement'],
  'Industrial & Manufacturing':['Industrial','Manufacturing'],
  'IT Services':['IT Services'],
  'Legal':['Legal','Legal Services'],
  'Marketing & Advertising':['Marketing & Advertising'],
  'Media':['Media'],
  'Nonprofit':['Nonprofit'],
  'Personal Services':['Personal Services'],
  'Public Administration':['Public Administration'],
  'Public Safety':['Public Safety'],
  'Real Estate':['Real Estate'],
  'Retail':['Retail'],
  'SaaS & Technology':['SaaS & Cloud','Software Development','SaaS','Technology','Electronics & Tech'],
  'Shopping & Gifts':['Shopping & Gifts'],
  'Sports & Recreation':['Sports & Recreation'],
  'Travel & Hospitality':['Recreation & Travel','Travel','Travel & Hospitality'],
  'Transportation':['Transportation'],
  'Venture Capital':['Venture Capital']
};

// Build reverse-lookup index
const ALIAS_INDEX = {};
for (const [canonical, aliases] of Object.entries(INDUSTRY_MAP)) {
  for (const alias of aliases) ALIAS_INDEX[alias] = canonical;
}

// =============================================
// TRIPLE WHALE MULTI-CHANNEL (existing logic)
// =============================================
const CHANNEL_GROUPS = {
  social:{label:'Social',channels:['Meta','TikTok','Snapchat','Pinterest Ads','Reddit','Twitter'],colors:{Meta:'#1877f2',TikTok:'#fe2c55',Snapchat:'#fffc00','Pinterest Ads':'#e60023',Reddit:'#ff4500',Twitter:'#1d9bf0'}},
  search:{label:'Search',channels:['Google Ads','Microsoft Ads'],colors:{'Google Ads':'#4285f4','Microsoft Ads':'#00a4ef'}},
  native:{label:'Native',channels:['Taboola','Outbrain','Criteo','StackAdapt','Adroll'],colors:{Taboola:'#005baa',Outbrain:'#e6420b',Criteo:'#f4811f',StackAdapt:'#6c3dc7',Adroll:'#0dadf1'}},
  marketplace:{label:'Marketplace',channels:['Amazon'],colors:{Amazon:'#ff9900'}},
  other:{label:'Other',channels:['Axon','AfterSell','Vibe','Mountain','Yotpo SMS and Email'],colors:{Axon:'#00c4b4',AfterSell:'#7c3aed',Vibe:'#6366f1',Mountain:'#22c55e','Yotpo SMS and Email':'#3b82f6'}}
};
const ALL_CHANNELS_COLOR={};
for(const g of Object.values(CHANNEL_GROUPS))for(const[c,col]of Object.entries(g.colors))ALL_CHANNELS_COLOR[c]=col;
const SUPER_CATEGORIES={
  'Health & Medical':['health_and_beauty','health_and_wellness','healthcare_providers','medical_devices_and_equipment','pharmaceuticals_and_biotech','senior_care'],
  'Finance & Business':['accounting_and_tax_services','financial_services','insurance','investment_and_wealth_management','consulting_and_professional_services','business_supplies_and_equipment'],
  'Tech & Software':['software_and_saas','technology_services','consumer_electronics','emerging_technology','telecommunications','gaming_and_apps'],
  'Retail & Commerce':['apparel_and_accessories','lifestyle_and_boutique','internet_and_ecommerce','toys_art_and_collectibles','baby','sports_and_outdoors'],
  'Home & Living':['home_and_garden','food_and_beverage','pets_and_animals','agriculture_and_food_production'],
  'Travel & Hospitality':['hotels_and_accommodation','travel_accessories_and_luggage','transportation_services','events_and_venues'],
  'Media & Entertainment':['entertainment','media_and_publishing','arts_and_culture','books_and_music'],
  'Education & Training':['elearning_and_online_courses','professional_training_and_coaching'],
  'Professional Services':['legal_services','hr_and_recruiting','marketing_and_advertising','real_estate','construction_and_engineering','manufacturing'],
  'Other':['nonprofit_and_philanthropy','energy_and_utilities','dating_and_personal_services','automotive','other']
};
const MONTH_ORDER={};const MN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
for(let y=22;y<=26;y++)for(let m=0;m<12;m++)MONTH_ORDER[`${MN[m]} ${y}`]=y*12+m;
function sortM(a,b){return(MONTH_ORDER[a]||0)-(MONTH_ORDER[b]||0)}
const DAY_NAMES=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

let currentRegion='global',currentGroup='all',selectedChannels=new Set();
let globalData={},usData={},dowData={},womData={},domData={};
let allIndustries=new Set(),allChannels=new Set(),totalRows=0;
const charts={};

function cleanNum(v){if(!v||v===''||v==='-')return null;let s=String(v).replace(/[$,%x]/g,'').replace(/,/g,'').trim();let n=parseFloat(s);return isNaN(n)?null:n}
function parseRow(r){return{cpm:cleanNum(r.CPM),cpc:cleanNum(r.CPC),ctr:cleanNum(r.CTR),cpa:cleanNum(r.CPA),cvr:cleanNum(r.Cvr),roas:cleanNum(r.ROAS),aov:cleanNum(r.AOV),mer:cleanNum(r.Mer)}}
function nest(o,ks){let c=o;for(const k of ks){if(!c[k])c[k]={};c=c[k]}return c}

async function loadCSV(f){const r=await fetch(f);const t=await r.text();return Papa.parse(t,{header:true,delimiter:'\t',skipEmptyLines:true}).data}

async function loadAll(){
  const[monthly,us,dow,wom,dom]=await Promise.all([loadCSV('monthly_benchmarks.csv'),loadCSV('us_benchmarks.csv'),loadCSV('benchmarks_by_day_of_week.csv'),loadCSV('benchmarks_by_week_of_month.csv'),loadCSV('benchmarks_by_day_of_month.csv')]);
  for(const r of monthly){const i=r.Industry,c=r.Channel,m=r.Month;if(!i||!c||!m)continue;allIndustries.add(i);allChannels.add(c);totalRows++;nest(globalData,[i,c])[m]=parseRow(r)}
  for(const r of us){const i=r.Industry,c=r.Channel;if(!i||!c)continue;totalRows++;nest(usData,[i])[c]=parseRow(r)}
  for(const r of dow){const i=r.Industry,c=r.Channel,d=r.Day_of_Week;if(!i||!c||!d)continue;totalRows++;nest(dowData,[i,c])[d]=parseRow(r)}
  for(const r of wom){const i=r.Industry,c=r.Channel,w=r.Week_of_Month;if(!i||!c||!w)continue;totalRows++;nest(womData,[i,c])[w]=parseRow(r)}
  for(const r of dom){const i=r.Industry,c=r.Channel,d=r.Day_of_Month;if(!i||!c||!d)continue;totalRows++;nest(domData,[i,c])[d]=parseRow(r)}
}

function getActiveChannels(){if(currentGroup==='all')return null;const g=CHANNEL_GROUPS[currentGroup];if(!g)return null;if(selectedChannels.size>0)return[...selectedChannels];return g.channels}
function filterChannels(co){const a=getActiveChannels();if(!a)return co;const o={};for(const c of a)if(co[c])o[c]=co[c];return o}
function avgMetrics(arr){const r={};for(const k of['cpm','cpc','ctr','cpa','cvr','roas','aov','mer']){const v=arr.map(m=>m[k]).filter(v=>v!=null);r[k]=v.length?v.reduce((a,b)=>a+b,0)/v.length:null}return r}
function getLatestGlobal(ind){const c=globalData[ind];if(!c)return null;const f=filterChannels(c);const ms=new Set();for(const ch in f)for(const m in f[ch])ms.add(m);const s=[...ms].sort(sortM);if(!s.length)return null;const l=s[s.length-1];const mets=[];for(const ch in f)if(f[ch][l])mets.push(f[ch][l]);return mets.length?avgMetrics(mets):null}
function getLatestUS(ind){const c=usData[ind];if(!c)return null;const f=filterChannels(c);return Object.values(f).length?avgMetrics(Object.values(f)):null}
function getLatestMetrics(ind){return currentRegion==='us'?getLatestUS(ind):getLatestGlobal(ind)}
function getChannelsFor(ind){if(currentRegion==='us')return usData[ind]?Object.keys(usData[ind]).sort():[];return globalData[ind]?Object.keys(globalData[ind]).sort():[]}
function hasSegmentData(ind){return!!(usData[ind]&&Object.keys(usData[ind]).length)}
function getGlobalMonthlyTrend(ind,metric,n){const c=globalData[ind];if(!c)return[];const f=filterChannels(c);const ms=new Set();for(const ch in f)for(const m in f[ch])ms.add(m);const s=[...ms].sort(sortM).slice(-n);return s.map(m=>{const mets=[];for(const ch in f)if(f[ch][m])mets.push(f[ch][m]);const a=mets.length?avgMetrics(mets):null;return{month:m,value:a?a[metric]:null}})}
function getTimeDim(store,ind,keys){const c=store[ind];if(!c)return keys.map(()=>null);const f=filterChannels(c);return keys.map(k=>{const mets=[];for(const ch in f)if(f[ch]&&f[ch][k])mets.push(f[ch][k]);return mets.length?avgMetrics(mets):null})}

function fmt(v,t){if(v==null)return'\u2014';switch(t){case'$':return'$'+v.toFixed(2);case'%':return v.toFixed(2)+'%';case'x':return v.toFixed(2)+'x';default:return v.toFixed(2)}}
function fmtInd(s){return s.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase()).replace(/\bAnd\b/g,'&').replace(/\bSaas\b/g,'SaaS').replace(/\bHr\b/g,'HR').replace(/\bElearning\b/g,'eLearning').replace(/\bEcommerce\b/g,'eCommerce')}
function metricClass(metric,value){if(value==null)return'';if(metric==='roas')return value>=2.5?'highlight':value>=1?'warn':'bad';if(metric==='mer')return value<0.5?'highlight':value<1?'warn':'bad';return''}

function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id]}}
function sparkline(id,data,color,label){destroyChart(id);const c=document.getElementById(id);if(!c)return;charts[id]=new Chart(c.getContext('2d'),{type:'line',data:{labels:data.map(d=>d.month||d.label||''),datasets:[{data:data.map(d=>d.value),borderColor:color||'#3b82f6',backgroundColor:(color||'#3b82f6')+'22',borderWidth:2,fill:true,tension:.35,pointRadius:0,pointHitRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>(label||'')+c.parsed.y?.toFixed(2)}}},scales:{x:{display:false},y:{display:false}},interaction:{mode:'index',intersect:false}}})}
function barChart(id,labels,values,color,valFmt){destroyChart(id);const c=document.getElementById(id);if(!c)return;charts[id]=new Chart(c.getContext('2d'),{type:'bar',data:{labels,datasets:[{data:values,backgroundColor:color+'88',borderColor:color,borderWidth:1,borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmt(c.parsed.y,valFmt)}}},scales:{x:{ticks:{color:'#64748b',font:{size:10}},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:10}},grid:{color:'#1e293b44'}}}}})}

function render(){
  document.getElementById('sI').textContent=allIndustries.size;
  document.getElementById('sC').textContent=allChannels.size;
  document.getElementById('sR').textContent=totalRows.toLocaleString();
  const main=document.getElementById('main');main.innerHTML='';
  for(const[cat,inds]of Object.entries(SUPER_CATEGORIES)){
    const avail=inds.filter(i=>allIndustries.has(i));if(!avail.length)continue;
    const sec=document.createElement('div');sec.className='super-cat';
    sec.innerHTML=`<div class="super-cat-hdr" onclick="toggleCat(this)"><span class="arr">&#9660;</span><h2>${cat}</h2><span class="cnt">${avail.length}</span></div><div class="grid" id="g-${cat.replace(/\W/g,'')}">${avail.map(i=>cardHTML(i)).join('')}</div>`;
    main.appendChild(sec);
  }
  requestAnimationFrame(()=>{for(const i of allIndustries)updateCard(i)});
}

function cardHTML(ind){
  const id=ind.replace(/\W/g,''),chs=getChannelsFor(ind),noUS=currentRegion==='us'&&!hasSegmentData(ind);
  const chText=chs.length?chs.slice(0,6).join(', ')+(chs.length>6?` +${chs.length-6} more`:''):'No data';
  return`<div class="card" id="c-${id}"><div class="card-top"><h3>${fmtInd(ind)}${noUS?'<span class="no-us">No segment data</span>':''}</h3><div class="card-channels" id="cch-${id}">${chText}</div><div class="metrics" id="met-${id}"><div class="metric" id="m-cpm-${id}"><div class="label">CPM</div><div class="val">\u2014</div><div class="sub">Cost per 1K</div></div><div class="metric" id="m-cpc-${id}"><div class="label">CPC</div><div class="val">\u2014</div><div class="sub">Cost per Click</div></div><div class="metric" id="m-ctr-${id}"><div class="label">CTR</div><div class="val">\u2014</div><div class="sub">Click-through</div></div><div class="metric" id="m-cpa-${id}"><div class="label">CPA</div><div class="val">\u2014</div><div class="sub">Cost per Acq.</div></div><div class="metric" id="m-roas-${id}"><div class="label">ROAS</div><div class="val">\u2014</div><div class="sub">Return on Spend</div></div><div class="metric" id="m-aov-${id}"><div class="label">AOV</div><div class="val">\u2014</div><div class="sub">Avg. Order</div></div><div class="metric" id="m-cvr-${id}"><div class="label">CVR</div><div class="val">\u2014</div><div class="sub">Conversion</div></div><div class="metric" id="m-mer-${id}"><div class="label">MER</div><div class="val">\u2014</div><div class="sub">Efficiency</div></div></div><div class="spark-row"><div class="spark-box"><div class="spark-label">CPM Trend</div><canvas id="sp-cpm-${id}"></canvas></div><div class="spark-box"><div class="spark-label">ROAS Trend</div><canvas id="sp-roas-${id}"></canvas></div></div></div><button class="expand-btn" onclick="toggleDetail('${id}','${ind}')"><span id="exp-${id}">See More &#9660;</span></button><div class="detail" id="det-${id}"></div></div>`;
}

function updateCard(ind){
  const id=ind.replace(/\W/g,''),m=getLatestMetrics(ind);
  setMetric(id,'cpm',m?.cpm,'$');setMetric(id,'cpc',m?.cpc,'$');setMetric(id,'ctr',m?.ctr,'%');setMetric(id,'cpa',m?.cpa,'$');
  setMetric(id,'roas',m?.roas,'x','roas');setMetric(id,'aov',m?.aov,'$');setMetric(id,'cvr',m?.cvr,'%');setMetric(id,'mer',m?.mer,'','mer');
  const chs=getChannelsFor(ind),chEl=document.getElementById(`cch-${id}`);
  if(chEl)chEl.textContent=chs.length?chs.slice(0,6).join(', ')+(chs.length>6?` +${chs.length-6} more`:''):'No data';
  if(currentRegion==='global'){sparkline(`sp-cpm-${id}`,getGlobalMonthlyTrend(ind,'cpm',8),'#3b82f6','$');sparkline(`sp-roas-${id}`,getGlobalMonthlyTrend(ind,'roas',8),'#22c55e','')}
  else{sparkline(`sp-cpm-${id}`,getGlobalMonthlyTrend(ind,'cpm',8),'#64748b','$');sparkline(`sp-roas-${id}`,getGlobalMonthlyTrend(ind,'roas',8),'#64748b','')}
  const det=document.getElementById(`det-${id}`);if(det&&det.classList.contains('open'))renderDetail(id,ind);
}

function setMetric(id,key,val,ft,ck){const el=document.getElementById(`m-${key}-${id}`);if(!el)return;el.querySelector('.val').textContent=fmt(val,ft);el.className='metric '+(ck?metricClass(ck,val):'')}

function toggleDetail(id,ind){const d=document.getElementById(`det-${id}`),e=document.getElementById(`exp-${id}`);if(d.classList.contains('open')){d.classList.remove('open');e.innerHTML='See More &#9660;'}else{d.classList.add('open');e.innerHTML='See Less &#9650;';renderDetail(id,ind)}}

function renderDetail(id,ind){
  const det=document.getElementById(`det-${id}`),isUS=currentRegion==='us';let rows='';
  if(isUS){const c=usData[ind];if(c){const f=filterChannels(c);for(const[ch,m]of Object.entries(f).sort((a,b)=>a[0].localeCompare(b[0]))){const col=ALL_CHANNELS_COLOR[ch]||'#64748b';rows+=`<tr><td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${col};margin-right:6px"></span>${ch}</td><td>${fmt(m.cpm,'$')}</td><td>${fmt(m.cpc,'$')}</td><td>${fmt(m.ctr,'%')}</td><td>${fmt(m.cpa,'$')}</td><td>${fmt(m.cvr,'%')}</td><td>${fmt(m.roas,'x')}</td><td>${fmt(m.aov,'$')}</td><td>${fmt(m.mer,'')}</td></tr>`}}}
  else{const c=globalData[ind];if(c){const f=filterChannels(c);const ms=new Set();for(const ch in f)for(const m in f[ch])ms.add(m);const s=[...ms].sort(sortM);const l=s[s.length-1];for(const[ch,mD]of Object.entries(f).sort((a,b)=>a[0].localeCompare(b[0]))){const m=mD[l];if(!m)continue;const col=ALL_CHANNELS_COLOR[ch]||'#64748b';rows+=`<tr><td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${col};margin-right:6px"></span>${ch}</td><td>${fmt(m.cpm,'$')}</td><td>${fmt(m.cpc,'$')}</td><td>${fmt(m.ctr,'%')}</td><td>${fmt(m.cpa,'$')}</td><td>${fmt(m.cvr,'%')}</td><td>${fmt(m.roas,'x')}</td><td>${fmt(m.aov,'$')}</td><td>${fmt(m.mer,'')}</td></tr>`}}}
  const dowId=`dow-${id}`,womId=`wom-${id}`,domId=`dom-${id}`,trendId=`trend-${id}`;
  det.innerHTML=`<div class="detail-section"><h4>Channel Breakdown${isUS?' ($1M-$10M GMV Tier)':' (All Markets, Latest Month)'}</h4>${rows?`<table class="tbl"><thead><tr><th>Channel</th><th>CPM</th><th>CPC</th><th>CTR</th><th>CPA</th><th>CVR</th><th>ROAS</th><th>AOV</th><th>MER</th></tr></thead><tbody>${rows}</tbody></table>`:'<div style="color:var(--text3);font-size:12px;padding:12px">No data for current selection</div>'}</div>${!isUS?`<div class="detail-section"><h4>ROAS Trend (12 Months)</h4><div class="chart-box"><canvas id="${trendId}"></canvas></div></div>`:''}<div class="detail-section"><h4>Time Patterns (Global)</h4><div class="chart-row"><div class="chart-box"><h5>CPA by Day of Week</h5><canvas id="${dowId}"></canvas></div><div class="chart-box"><h5>CPA by Week of Month</h5><canvas id="${womId}"></canvas></div></div><div class="chart-row" style="margin-top:12px"><div class="chart-box" style="grid-column:1/-1"><h5>CPA by Day of Month (Days 10-16, partial)</h5><canvas id="${domId}"></canvas></div></div></div>`;
  requestAnimationFrame(()=>{
    if(!isUS){const rt=getGlobalMonthlyTrend(ind,'roas',12);barChart(trendId,rt.map(d=>d.month),rt.map(d=>d.value),'#22c55e','x')}
    const dk=['1','2','3','4','5','6','7'],dm=getTimeDim(dowData,ind,dk),dv=dm.map(m=>m?.cpa??null);if(dv.some(v=>v!=null))barChart(dowId,DAY_NAMES,dv,'#3b82f6','$');
    const wk=['1','2','3','4','5'],wm=getTimeDim(womData,ind,wk),wv=wm.map(m=>m?.cpa??null);if(wv.some(v=>v!=null))barChart(womId,['Wk 1','Wk 2','Wk 3','Wk 4','Wk 5'],wv,'#a78bfa','$');
    const domK=[];for(let d=10;d<=16;d++)domK.push(String(d));const domM=getTimeDim(domData,ind,domK),domV=domM.map(m=>m?.cpa??null);if(domV.some(v=>v!=null))barChart(domId,domK.map(d=>'Day '+d),domV,'#f59e0b','$');
  });
}

function toggleCat(hdr){hdr.classList.toggle('collapsed');hdr.nextElementSibling.classList.toggle('hidden')}

document.getElementById('regionToggle').addEventListener('click',e=>{const b=e.target.closest('.region-btn');if(!b)return;document.querySelectorAll('.region-btn').forEach(b=>b.classList.remove('active'));b.classList.add('active');currentRegion=b.dataset.region;render()});
document.getElementById('chGroupBar').addEventListener('click',e=>{const b=e.target.closest('.ch-group-btn');if(!b)return;document.querySelectorAll('.ch-group-btn').forEach(b=>b.classList.remove('active'));b.classList.add('active');currentGroup=b.dataset.group;selectedChannels.clear();renderSubChannels();refreshAllCards()});

function renderSubChannels(){const s=document.getElementById('chSubBar');if(currentGroup==='all'){s.innerHTML='';return}const g=CHANNEL_GROUPS[currentGroup];if(!g){s.innerHTML='';return}s.innerHTML=g.channels.map(ch=>{const c=g.colors[ch]||'#666';const sel=selectedChannels.size===0||selectedChannels.has(ch);return`<button class="ch-sub-btn${sel?' selected':''}" style="background:${c}${sel?'':'44'};color:${sel?'#fff':'#999'}" data-ch="${ch}" onclick="toggleSubCh(this)">${ch}</button>`}).join('')}
function toggleSubCh(btn){const ch=btn.dataset.ch,g=CHANNEL_GROUPS[currentGroup];if(!g)return;if(selectedChannels.size===0){selectedChannels.add(ch)}else if(selectedChannels.has(ch)){selectedChannels.delete(ch)}else{selectedChannels.add(ch);if(selectedChannels.size===g.channels.length)selectedChannels.clear()}renderSubChannels();refreshAllCards()}
function refreshAllCards(){for(const i of allIndustries)updateCard(i)}

document.getElementById('searchInput').addEventListener('input',function(){const q=this.value.toLowerCase().trim();document.querySelectorAll('.super-cat').forEach(cat=>{const cards=cat.querySelectorAll('.card');let any=false;cards.forEach(c=>{const n=c.querySelector('h3').textContent.toLowerCase();const match=!q||n.includes(q);c.style.display=match?'':'none';if(match)any=true});cat.style.display=any?'':'none';if(q&&any){cat.querySelector('.grid').classList.remove('hidden');cat.querySelector('.super-cat-hdr').classList.remove('collapsed')}})});

// =============================================
// META ADS MULTI-SOURCE DATA
// =============================================
const N=null;
const SRC_COLORS={Superads:'#10b981',Vaizle:'#8b5cf6',WordStream:'#f59e0b','WS Leads':'#ef4444',Databox:'#3b82f6',Madgicx:'#ec4899','ADCostly+':'#06b6d4',Revealbot:'#f97316'};
const SRC_GEO={Superads:'Global',Vaizle:'Global',WordStream:'US',
  'WS Leads':'US',Databox:'Mixed',Madgicx:'Global','ADCostly+':'Global',Revealbot:'US'};
const GEO_BADGE_STYLE={US:'background:rgba(239,68,68,.15);color:#f87171',
  Global:'background:rgba(34,197,94,.12);color:#4ade80',
  Mixed:'background:rgba(245,158,11,.12);color:#fbbf24'};

// [industry, source, cpm, cpc, ctr, cpa, cvr, roas]
const MI=[
['Agriculture','Superads',8.96,0.51,2.51,N,N,N],['Arts','Superads',14.70,0.61,2.64,N,N,N],['Construction','Superads',23.39,1.41,1.74,N,N,N],
['Consulting','Superads',43.40,1.31,3.69,N,N,N],['Consumer Goods','Superads',20.02,1.30,1.68,N,N,N],['Crypto & Blockchain','Superads',20.15,2.51,0.74,N,N,N],
['Design','Superads',38.70,2.82,1.88,N,N,N],['E-commerce','Superads',17.88,0.98,1.94,N,N,N],['Education','Superads',16.90,1.05,1.66,N,N,N],
['Energy & Mining','Superads',34.94,1.59,2.24,N,N,N],['Entertainment','Superads',9.27,0.38,2.43,N,N,N],['Finance','Superads',27.80,1.44,1.87,N,N,N],
['Fitness & Training','Superads',19.95,1.24,1.80,N,N,N],['Gaming','Superads',12.33,1.41,0.94,N,N,N],['Hardware & Networking','Superads',12.22,0.77,1.85,N,N,N],
['Healthcare','Superads',27.30,1.66,1.69,N,N,N],['HR & Staffing','Superads',19.91,1.86,1.34,N,N,N],['IT Services','Superads',42.17,1.52,2.91,N,N,N],
['Legal','Superads',49.70,2.68,1.82,N,N,N],['Manufacturing','Superads',10.17,0.69,1.57,N,N,N],['Marketing & Advertising','Superads',34.50,1.31,2.30,N,N,N],
['Marketplaces','Superads',9.58,0.56,2.17,N,N,N],['Media','Superads',17.12,0.53,3.40,N,N,N],['Nonprofit','Superads',15.36,0.39,3.95,N,N,N],
['Public Administration','Superads',5.88,0.48,1.35,N,N,N],['Public Safety','Superads',18.90,1.21,1.82,N,N,N],['Real Estate','Superads',29.85,1.17,2.75,N,N,N],
['Recreation & Travel','Superads',10.74,0.57,1.95,N,N,N],['Retail','Superads',15.72,0.86,1.95,N,N,N],['SaaS & Cloud','Superads',24.46,1.97,1.20,N,N,N],
['Software Development','Superads',10.00,0.70,2.00,N,N,N],['Textiles','Superads',13.54,0.67,2.48,N,N,N],['Transportation','Superads',15.43,0.98,1.64,N,N,N],
['Venture Capital','Superads',47.80,2.16,2.47,N,N,N],['Wellness','Superads',27.35,1.39,1.99,N,N,N],['Wine & Spirits','Superads',14.10,1.02,1.75,N,N,N],
// Vaizle (5,200+ Meta accounts, Aug 2025)
['E-commerce','Vaizle',10.76,1.37,2.46,N,N,2.00],['Education','Vaizle',5.25,0.70,1.20,N,N,1.50],['Finance & Insurance','Vaizle',18.45,2.34,2.31,N,N,3.50],
['Food & Beverage','Vaizle',2.82,0.36,3.67,N,N,0.50],['Health & Wellness','Vaizle',4.76,1.48,2.59,N,N,1.80],['Real Estate','Vaizle',5.13,1.20,1.89,N,N,2.10],
['Technology','Vaizle',6.94,1.10,1.91,N,N,2.30],['Marketing & Advertising','Vaizle',8.11,1.45,1.33,N,N,0.90],['Travel & Hospitality','Vaizle',7.23,1.88,2.09,N,N,1.00],
['Retail','Vaizle',9.02,0.82,2.88,N,N,2.50],
// WordStream 2025 Traffic campaigns
['Animals & Pets','WordStream',N,0.78,1.64,N,N,N],['Apparel & Fashion','WordStream',N,0.86,1.29,N,N,N],['Arts & Entertainment','WordStream',N,0.49,2.10,N,N,N],
['Legal Services','WordStream',N,0.86,1.76,N,N,N],['Automotive','WordStream',N,0.79,1.48,N,N,N],['Beauty & Personal Care','WordStream',N,0.74,1.81,N,N,N],
['Business Services','WordStream',N,0.75,1.38,N,N,N],['Education','WordStream',N,0.86,1.45,N,N,N],['Finance & Insurance','WordStream',N,1.22,0.98,N,N,N],
['Furniture','WordStream',N,0.85,1.39,N,N,N],['Health & Fitness','WordStream',N,0.80,1.63,N,N,N],['Home Improvement','WordStream',N,0.99,1.28,N,N,N],
['Industrial','WordStream',N,0.86,1.36,N,N,N],['Personal Services','WordStream',N,1.00,1.70,N,N,N],['Healthcare','WordStream',N,0.82,0.83,N,N,N],
['Real Estate','WordStream',N,0.91,1.68,N,N,N],['Restaurants & Food','WordStream',N,0.72,1.67,N,N,N],['Shopping & Gifts','WordStream',N,0.34,4.13,N,N,N],
['Sports & Recreation','WordStream',N,0.41,2.60,N,N,N],['Travel','WordStream',N,0.51,2.76,N,N,N],
// WordStream 2025 Lead campaigns
['Arts & Entertainment','WS Leads',N,1.08,3.92,18.17,9.34,N],['Legal Services','WS Leads',N,4.10,2.11,18.17,10.53,N],
['Beauty & Personal Care','WS Leads',N,3.06,2.55,51.42,5.29,N],['Education','WS Leads',N,1.65,1.86,28.22,10.08,N],
['Health & Fitness','WS Leads',N,2.64,1.72,52.98,5.63,N],['Home Improvement','WS Leads',N,2.23,1.94,41.26,5.22,N],
['Industrial','WS Leads',N,1.80,2.08,37.34,9.34,N],['Personal Services','WS Leads',N,2.08,1.99,30.57,6.51,N],
['Healthcare','WS Leads',N,2.23,3.02,47.47,4.51,N],['Real Estate','WS Leads',N,1.57,3.75,16.61,9.53,N],
['Restaurants & Food','WS Leads',N,0.74,2.97,3.16,18.25,N],['Sports & Recreation','WS Leads',N,1.07,3.41,19.30,5.48,N],
['Furniture','WS Leads',N,2.18,1.48,40.04,3.77,N],['Dentists','WS Leads',N,9.78,1.05,76.71,6.38,N],
['Career & Employment','WS Leads',N,0.86,2.81,17.64,5.77,N],
// Madgicx (Sep 2025 - Jan 2026)
['Fashion & Apparel','Madgicx',10.14,0.40,2.64,N,N,N],['Electronics & Tech','Madgicx',6.94,1.10,1.91,N,N,N],
['Beauty & Cosmetics','Madgicx',12.78,0.77,1.58,N,5.93,N],['Home Improvement','Madgicx',N,0.67,1.72,N,8.87,N],
['Health & Fitness','Madgicx',N,0.71,1.70,N,5.78,N],['Real Estate','Madgicx',10.97,1.81,N,N,N,N],
['Sports & Fitness','Madgicx',14.02,1.90,N,N,N,N],
// Databox CTR by industry (Focus Digital citing Databox, 2025-2026)
['Arts & Entertainment','Databox',N,N,2.64,N,N,N],['Real Estate','Databox',N,N,2.60,N,N,N],['Travel & Hospitality','Databox',N,N,2.29,N,N,N],
['Food & Restaurants','Databox',N,N,2.19,N,N,N],['Apparel & Footwear','Databox',N,N,2.06,N,N,N],['Animals & Pets','Databox',N,N,1.87,N,N,N],
['E-commerce','Databox',N,N,1.75,N,N,N],['Health & Fitness','Databox',N,N,1.61,N,N,N],['Legal Services','Databox',N,N,1.61,N,N,N],
['Retail','Databox',N,N,1.59,N,N,N],['Consulting','Databox',N,N,1.37,N,N,N],['Education','Databox',N,N,1.29,N,N,N],
['SaaS','Databox',N,N,1.12,N,N,N],['Technology','Databox',N,N,1.04,N,N,N],['Finance & Insurance','Databox',N,N,0.85,N,N,N],['Healthcare','Databox',N,N,0.73,N,N,N]
];

// [country, source, cpm, cpc, ctr]
const MC=[
// Superads (Feb 2025-Jan 2026, $3B+ spend)
['United States','Superads',22.20,1.24,1.91],['United Kingdom','Superads',19.60,1.17,1.73],['New Zealand','Superads',19.05,0.89,2.08],
['Singapore','Superads',21.50,1.61,1.33],['UAE','Superads',19.20,1.30,1.39],['Australia','Superads',15.73,1.01,1.78],
['Germany','Superads',14.27,0.92,1.57],['Norway','Superads',14.03,0.84,1.63],['Canada','Superads',12.90,0.92,1.45],
['Sweden','Superads',11.00,0.86,1.29],['Netherlands','Superads',11.18,0.73,1.53],['Italy','Superads',9.56,0.47,2.05],
['France','Superads',9.67,0.76,1.33],['Denmark','Superads',8.61,0.76,1.57],['Israel','Superads',8.38,0.57,1.48],
['Spain','Superads',6.06,0.36,1.80],['Argentina','Superads',3.74,0.23,2.20],['Brazil','Superads',3.33,0.35,1.07],
['South Africa','Superads',2.82,0.22,1.50],['Colombia','Superads',1.96,0.19,1.73],['India','Superads',1.81,0.17,1.31],
['Philippines','Superads',1.33,0.16,1.93],
// Vaizle (5,200+ accounts, Aug 2025)
['United States','Vaizle',19.66,1.67,3.49],['United Kingdom','Vaizle',23.79,2.04,N],['Australia','Vaizle',15.65,1.47,N],
['Europe','Vaizle',4.90,1.18,N],['UAE','Vaizle',7.47,1.06,N],['India','Vaizle',2.51,0.41,3.71],
['Canada','Vaizle',7.15,2.97,N],['SE Asia','Vaizle',5.93,0.56,3.05],['Africa','Vaizle',1.76,0.24,N],['Egypt','Vaizle',1.94,0.34,N],
// ADCostly/SRZone/Enhencer composite (2024-2025) - selected countries not in Superads
['Iceland','ADCostly+',17.00,2.80,1.20],['Kazakhstan','ADCostly+',11.50,1.90,1.30],['South Africa','ADCostly+',12.50,2.20,1.30],
['Ireland','ADCostly+',11.08,1.90,1.40],['Philippines','ADCostly+',10.19,1.60,1.20],['Portugal','ADCostly+',9.39,2.20,1.30],
['Switzerland','ADCostly+',9.26,2.40,1.25],['Poland','ADCostly+',8.94,1.80,1.35],['Belgium','ADCostly+',8.72,2.20,1.30],
['Austria','ADCostly+',8.20,2.10,1.30],['Hong Kong','ADCostly+',8.12,2.00,1.15],['Luxembourg','ADCostly+',7.80,2.30,1.25],
['South Korea','ADCostly+',7.72,2.50,1.10],['Japan','ADCostly+',6.74,3.10,1.05],['Finland','ADCostly+',6.53,2.50,1.25],
['Mexico','ADCostly+',5.26,1.90,1.60],['Russia','ADCostly+',5.04,1.80,1.30],['Hungary','ADCostly+',4.85,1.70,1.35],
['Croatia','ADCostly+',4.82,1.60,1.40],['Greece','ADCostly+',3.93,1.50,1.45],['Slovenia','ADCostly+',3.62,1.40,1.40],
['Malaysia','ADCostly+',3.42,1.80,1.30],['Nigeria','ADCostly+',3.00,1.20,1.50],['Ukraine','ADCostly+',2.80,1.40,1.35],
['Saudi Arabia','ADCostly+',1.60,2.30,1.15],['Indonesia','ADCostly+',1.80,1.50,1.50],['Czech Republic','ADCostly+',1.00,1.90,1.40],
['Kenya','ADCostly+',1.00,0.80,1.55],['Turkey','ADCostly+',0.89,0.10,0.88],['Taiwan','ADCostly+',0.80,1.50,1.35],
['Chile','ADCostly+',0.80,2.00,1.45],['Costa Rica','ADCostly+',0.80,1.60,1.50],['Thailand','ADCostly+',0.60,1.60,1.45],
['Morocco','ADCostly+',0.60,0.50,1.45],['Argentina','ADCostly+',0.60,2.10,1.40],['Egypt','ADCostly+',0.59,0.04,1.58],
['Pakistan','ADCostly+',0.60,0.08,1.45],['Bangladesh','ADCostly+',0.40,0.15,1.80],['Peru','ADCostly+',0.40,1.70,1.50],
['Colombia','ADCostly+',0.40,1.80,1.55],['Vietnam','ADCostly+',0.20,1.40,1.50],['Jordan','ADCostly+',0.80,0.60,1.40]
];

// Overall benchmarks from each source
const META_OVERALL={
  'Databox (2,800+ co.)':{cpm:7.13,cpc:0.35,ctr:1.91,roas:2.89,cpp:10.18},
  'Superads ($3B spend)':{cpm:19.81,cpc:1.11,ctr:1.86,roas:N,cpp:N},
  'Vaizle (5,200 accts)':{cpm:5.97,cpc:0.82,ctr:2.46,roas:2.33,cpp:N},
  'Revealbot (US, Feb 26)':{cpm:14.38,cpc:0.86,ctr:N,roas:N,cpp:N}
};

// Revealbot monthly FB/IG trends
const RB_MONTHS=['Feb 25','Mar 25','Apr 25','May 25','Jun 25','Jul 25','Aug 25','Sep 25','Oct 25','Nov 25','Dec 25','Jan 26','Feb 26'];
const RB_FB_CPM=[13.33,14.24,15.32,15.89,15.04,16.03,15.93,15.98,15.94,16.56,16.18,14.97,14.38];
const RB_FB_CPC=[0.76,0.83,0.84,0.85,0.74,0.80,0.80,0.88,0.90,0.96,0.84,0.88,0.86];
const RB_IG_CPM=[13.56,13.56,13.84,14.12,13.17,13.18,12.83,13.87,14.97,17.23,16.76,15.56,14.71];

// CTR by campaign objective (Databox/Focus Digital)
const OBJ_CTR=[['Lead Gen',2.53],['Traffic',1.57],['Engagement',1.42],['Conversions',1.38],['Video Views',1.21],['Brand Awareness',0.94],['Reach',0.87]];

// CTR by placement (Databox/Focus Digital)
const PLACE_CTR=[['IG Stories',1.34],['FB Feed',1.11],['IG Feed',1.01],['FB Reels',0.94],['FB Stories',0.83],['IG Reels',0.76],['Audience Net.',0.58],['Right Column',0.41]];

// Revealbot CPM by objective (monthly averages)
const RB_OBJ_CPM_LABELS=['App Install','Brand Aware.','Catalog Sales','Conversions','Lead Gen','Traffic','Video Views'];
const RB_OBJ_CPM_LATEST=[3.25,2.24,16.19,6.34,17.53,8.78,2.65]; // Feb 2026

// =============================================
// DATA PIPELINE — Normalization & Consensus
// =============================================
const INDUSTRY_METRICS = ['cpm','cpc','ctr','cpa','cvr','roas'];
const COUNTRY_METRICS = ['cpm','cpc','ctr'];
const ALL_MI_SOURCES = ['Superads','Vaizle','WordStream','WS Leads','Madgicx','Databox'];
const ALL_MC_SOURCES = ['Superads','Vaizle','ADCostly+'];

let activeMetaSources = new Set(ALL_MI_SOURCES);
let activeCountrySources = new Set(ALL_MC_SOURCES);
let metaViewMode = 'consensus';
let normalizedIndustries = {};
let normalizedCountries = {};

function buildNormalizedIndustries() {
  const grouped = {};
  for (const row of MI) {
    const [rawName, source, cpm, cpc, ctr, cpa, cvr, roas] = row;
    if (!activeMetaSources.has(source)) continue;
    const canonical = ALIAS_INDEX[rawName] || 'Other / Unmatched';
    if (!grouped[canonical]) grouped[canonical] = [];
    grouped[canonical].push({ source, cpm, cpc, ctr, cpa, cvr, roas, rawName });
  }
  const result = {};
  for (const [ind, rows] of Object.entries(grouped)) {
    // Enhanced pipeline: impute → temporal → geo → IVW
    const consensus = StatEngine.computeConsensus(rows, INDUSTRY_METRICS, { geoTarget: 'us' });
    consensus._rows = rows;
    consensus._sources = [...new Set(rows.map(r => r.source))];
    consensus._sourceCount = consensus._sources.length;
    const levels = { none: 0, single: 1, agreement: 2, moderate: 3, disagreement: 4, conflict: 5 };
    let worst = 'none';
    for (const m of INDUSTRY_METRICS) {
      if (consensus[m] && levels[consensus[m].disagreement] > levels[worst]) worst = consensus[m].disagreement;
    }
    consensus._overallDisagreement = worst;
    result[ind] = consensus;
  }
  // Step 5: James-Stein shrinkage across industries (sparse → grand mean)
  StatEngine.applyShrinkage(result, INDUSTRY_METRICS);
  return result;
}

function buildNormalizedCountries() {
  const grouped = {};
  for (const row of MC) {
    const [country, source, cpm, cpc, ctr] = row;
    if (!activeCountrySources.has(source)) continue;
    if (!grouped[country]) grouped[country] = [];
    grouped[country].push({ source, cpm, cpc, ctr });
  }
  const result = {};
  for (const [country, rows] of Object.entries(grouped)) {
    // Country data: apply temporal adjustment but NOT geographic correction
    // (country data is already geo-specific)
    const consensus = StatEngine.computeConsensus(rows, COUNTRY_METRICS, { geoTarget: 'global' });
    consensus._rows = rows;
    consensus._sources = [...new Set(rows.map(r => r.source))];
    consensus._sourceCount = consensus._sources.length;
    const levels = { none: 0, single: 1, agreement: 2, moderate: 3, disagreement: 4, conflict: 5 };
    let worst = 'none';
    for (const m of COUNTRY_METRICS) {
      if (consensus[m] && levels[consensus[m].disagreement] > levels[worst]) worst = consensus[m].disagreement;
    }
    consensus._overallDisagreement = worst;
    result[country] = consensus;
  }
  // Apply shrinkage for sparse countries
  StatEngine.applyShrinkage(result, COUNTRY_METRICS);
  return result;
}

// =============================================
// META ADS — UI HELPERS
// =============================================
const DISAGREE_COLORS = {
  none: '#64748b', single: '#3b82f6', agreement: '#22c55e',
  moderate: '#f59e0b', disagreement: '#f97316', conflict: '#ef4444'
};
const DISAGREE_LABELS = {
  none: 'No data', single: 'Single source', agreement: 'Agreement',
  moderate: 'Moderate', disagreement: 'Disagreement', conflict: 'Conflict'
};
const DISAGREE_WIDTH = { none: 0, single: 100, agreement: 100, moderate: 70, disagreement: 40, conflict: 15 };

function fmtMetric(v, metric) {
  if (v == null) return '\u2014';
  if (metric === 'cpm' || metric === 'cpc' || metric === 'cpa') return '$' + v.toFixed(2);
  if (metric === 'ctr' || metric === 'cvr') return v.toFixed(2) + '%';
  if (metric === 'roas') return v.toFixed(2) + 'x';
  return v.toFixed(2);
}

function fmtDev(dev) {
  if (dev == null) return '';
  const sign = dev >= 0 ? '+' : '';
  return sign + dev.toFixed(0) + '%';
}

function devClass(dev) {
  if (dev == null) return 'dev-neutral';
  const abs = Math.abs(dev);
  if (abs > 30) return dev > 0 ? 'dev-positive' : 'dev-negative';
  if (abs > 15) return dev > 0 ? 'dev-positive' : 'dev-negative';
  return 'dev-neutral';
}

function devCellClass(dev) {
  if (dev == null) return '';
  const abs = Math.abs(dev);
  if (abs > 30) return 'hot';
  if (abs > 15) return 'warm';
  return 'cool';
}

function dataBadge(sourceCount) {
  if (sourceCount <= 1) return '<span class="data-badge single">Single source</span>';
  if (sourceCount === 2) return '<span class="data-badge limited">Limited data</span>';
  return '<span class="data-badge good">' + sourceCount + ' sources</span>';
}

// =============================================
// META ADS RENDERING
// =============================================
let metaView='overview',metaSortCol=null,metaSortAsc=true;

function showSubControls(show, type) {
  const ctrl = document.getElementById('metaSubControls');
  ctrl.style.display = show ? '' : 'none';
  if (!show) return;
  // Render source pills
  const pills = document.getElementById('sourcePills');
  const sources = type === 'country' ? ALL_MC_SOURCES : ALL_MI_SOURCES;
  const active = type === 'country' ? activeCountrySources : activeMetaSources;
  let h = '<span class="source-pills-label">Sources:</span>';
  for (const src of sources) {
    const color = SRC_COLORS[src] || '#666';
    const isActive = active.has(src);
    const geo = SRC_GEO[src] || '';
    h += `<span class="source-pill${isActive ? ' active' : ''}" style="background:${color}${isActive ? '' : '44'};color:${isActive ? '#fff' : '#999'}" data-src="${src}" data-type="${type}" onclick="toggleSourcePill(this)">${src} <span style="font-size:9px;opacity:.7">${geo}</span></span>`;
  }
  pills.innerHTML = h;
  // Render view toggle state
  document.querySelectorAll('.view-toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === metaViewMode);
  });
}

function toggleSourcePill(el) {
  const src = el.dataset.src;
  const type = el.dataset.type;
  const active = type === 'country' ? activeCountrySources : activeMetaSources;
  if (active.has(src)) {
    if (active.size > 1) active.delete(src);
  } else {
    active.add(src);
  }
  if (type === 'country') {
    normalizedCountries = buildNormalizedCountries();
    renderMetaCountry();
  } else {
    normalizedIndustries = buildNormalizedIndustries();
    renderMetaIndustry();
  }
  showSubControls(true, type);
}

document.getElementById('viewToggle').addEventListener('click', e => {
  const btn = e.target.closest('.view-toggle-btn');
  if (!btn) return;
  metaViewMode = btn.dataset.mode;
  document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === metaViewMode));
  if (metaView === 'industry') renderMetaIndustry();
  else if (metaView === 'country') renderMetaCountry();
});

document.getElementById('metaSearchInput').addEventListener('input', function() {
  const q = this.value.toLowerCase().trim();
  document.querySelectorAll('.ind-section,.ctry-section').forEach(el => {
    const name = (el.dataset.name || '').toLowerCase();
    el.style.display = (!q || name.includes(q)) ? '' : 'none';
  });
});

function renderMeta(){
  const v=metaView;
  if(v==='overview'){showSubControls(false);renderMetaOverview()}
  else if(v==='industry'){showSubControls(true,'industry');renderMetaIndustry()}
  else if(v==='country'){showSubControls(true,'country');renderMetaCountry()}
  else if(v==='trends'){showSubControls(false);renderMetaTrends()}
  else if(v==='objectives'){showSubControls(false);renderMetaObjectives()}
}

// ——— OVERVIEW ———
function renderMetaOverview(){
  const mm=document.getElementById('metaMain');
  // Compute overall consensus from META_OVERALL
  const overallSources = Object.entries(META_OVERALL);
  const cpmVals = overallSources.filter(([,d]) => d.cpm != null).map(([,d]) => d.cpm);
  const cpcVals = overallSources.filter(([,d]) => d.cpc != null).map(([,d]) => d.cpc);
  const ctrVals = overallSources.filter(([,d]) => d.ctr != null).map(([,d]) => d.ctr);
  const roasVals = overallSources.filter(([,d]) => d.roas != null).map(([,d]) => d.roas);
  const cpmW = [0.75,0.85,0.70,0.80]; // Databox,Superads,Vaizle,Revealbot
  const consensusCPM = StatEngine.computeWeightedMean(cpmVals, cpmW.slice(0, cpmVals.length));
  const consensusCPC = StatEngine.computeWeightedMean(cpcVals, cpmW.slice(0, cpcVals.length));

  let h=`<div class="section-title">Meta Ads Benchmarks Overview</div>`;
  h+=`<div class="sources-bar">`;
  for(const[s,c]of Object.entries(SRC_COLORS)){const geo=SRC_GEO[s]||'';const gs=GEO_BADGE_STYLE[geo]||'';h+=`<span class="src-badge" style="border-color:${c};color:${c}">${s}${geo?` <span class="geo-tag" style="${gs}">${geo}</span>`:''}</span>`;}
  h+=`</div>`;

  h+=`<div class="kpi-grid">`;
  h+=`<div class="kpi-card"><div class="kpi-label">Consensus CPM</div><div class="kpi-val">$${consensusCPM.toFixed(2)}</div><div class="kpi-range" style="font-size:10px">${cpmVals.map((v,i) => '$'+v.toFixed(2)+' <span style="color:var(--text3)">'+overallSources.filter(([,d])=>d.cpm!=null).map(([n])=>n)[i].split('(')[0].trim()+'</span>').join(' · ')}</div></div>`;
  h+=`<div class="kpi-card"><div class="kpi-label">Consensus CPC</div><div class="kpi-val">$${consensusCPC.toFixed(2)}</div><div class="kpi-range" style="font-size:10px">${cpcVals.map((v,i) => '$'+v.toFixed(2)+' <span style="color:var(--text3)">'+overallSources.filter(([,d])=>d.cpc!=null).map(([n])=>n)[i].split('(')[0].trim()+'</span>').join(' · ')}</div></div>`;
  const avgCTR = ctrVals.reduce((a,b)=>a+b,0)/ctrVals.length;
  h+=`<div class="kpi-card"><div class="kpi-label">Avg CTR</div><div class="kpi-val">${avgCTR.toFixed(2)}%</div><div class="kpi-sub">Across ${ctrVals.length} sources</div></div>`;
  const avgROAS = roasVals.reduce((a,b)=>a+b,0)/roasVals.length;
  h+=`<div class="kpi-card"><div class="kpi-label">Median ROAS</div><div class="kpi-val">${avgROAS.toFixed(2)}x</div><div class="kpi-sub">Databox + Vaizle</div></div>`;
  h+=`<div class="kpi-card"><div class="kpi-label">Canonical Industries</div><div class="kpi-val">${Object.keys(normalizedIndustries).length}</div><div class="kpi-sub">Mapped from ${MI.length} data points</div></div>`;
  h+=`<div class="kpi-card"><div class="kpi-label">Countries</div><div class="kpi-val">${Object.keys(normalizedCountries).length}</div><div class="kpi-sub">From ${MC.length} data points</div></div>`;
  h+=`</div>`;

  // Key insights
  h+=`<div class="section-title" style="margin-top:12px">Key Insights</div>`;
  h+=`<div class="insight-cards">`;
  const insights=[
    {t:'Most Expensive Industry',v:'Legal $49.70 CPM',d:'Superads data. 2.5x the global average.'},
    {t:'Cheapest Industry',v:'Public Admin $5.88 CPM',d:'Superads data. 70% below average.'},
    {t:'Highest CTR Industry',v:'Nonprofit 3.95%',d:'Superads. Shopping & Gifts 4.13% (WordStream).'},
    {t:'Cheapest Country',v:'Philippines $1.33 CPM',d:'Superads. Vietnam $0.20 (ADCostly).'},
    {t:'Most Expensive Country',v:'US $22.20 CPM',d:'Superads. Singapore $21.50 close behind.'},
    {t:'Best Lead CVR',v:'Restaurants 18.25%',d:'WordStream lead campaigns. CPA only $3.16.'},
    {t:'Q4 CPM Spike',v:'$18.40 peak (Nov)',d:'Revealbot. Black Friday week 42% above January.'},
    {t:'FB vs IG CPM',v:'IG 3% higher avg',d:'Revealbot. IG $14.71 vs FB $14.38 (Feb 2026).'}
  ];
  for(const i of insights)h+=`<div class="insight"><h6>${i.t}</h6><div class="val">${i.v}</div><div class="desc">${i.d}</div></div>`;
  h+=`</div>`;

  h+=`<div class="meta-chart-grid"><div class="meta-chart-box wide"><h5>Facebook vs Instagram CPM Trend (Revealbot, US)</h5><canvas id="mc-overview-trend"></canvas></div></div>`;
  mm.innerHTML=h;
  requestAnimationFrame(()=>{
    const c=document.getElementById('mc-overview-trend');if(!c)return;
    destroyChart('mc-overview-trend');
    charts['mc-overview-trend']=new Chart(c.getContext('2d'),{type:'line',data:{labels:RB_MONTHS,datasets:[
      {label:'Facebook CPM',data:RB_FB_CPM,borderColor:'#1877f2',backgroundColor:'#1877f222',borderWidth:2,fill:true,tension:.3,pointRadius:3},
      {label:'Instagram CPM',data:RB_IG_CPM,borderColor:'#e4405f',backgroundColor:'#e4405f22',borderWidth:2,fill:true,tension:.3,pointRadius:3}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}},scales:{x:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'#1e293b44'}},y:{ticks:{color:'#475569',font:{size:10},callback:v=>'$'+v},grid:{color:'#1e293b44'}}},interaction:{mode:'index',intersect:false}}});
  });
}

// ——— BY INDUSTRY (spacious full-width sections) ———
function renderMetaIndustry(){
  const mm=document.getElementById('metaMain');
  const data = normalizedIndustries;
  let sorted = Object.entries(data).sort((a,b) => {
    // Sort by source count desc, then alphabetically
    if (b[1]._sourceCount !== a[1]._sourceCount) return b[1]._sourceCount - a[1]._sourceCount;
    return a[0].localeCompare(b[0]);
  });

  if (metaSortCol) {
    sorted.sort((a,b) => {
      if (metaSortCol === 'name') return metaSortAsc ? a[0].localeCompare(b[0]) : b[0].localeCompare(a[0]);
      if (metaSortCol === 'sources') return metaSortAsc ? a[1]._sourceCount - b[1]._sourceCount : b[1]._sourceCount - a[1]._sourceCount;
      const va = a[1][metaSortCol]?.value ?? -Infinity;
      const vb = b[1][metaSortCol]?.value ?? -Infinity;
      return metaSortAsc ? va - vb : vb - va;
    });
  }

  let h = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">`;
  h += `<div class="section-title" style="border:none;margin:0;padding:0">Meta Ads by Industry <span style="font-size:13px;color:var(--text3);font-weight:400">${sorted.length} canonical industries from ${activeMetaSources.size} sources</span></div>`;
  h += `<div style="display:flex;gap:6px;flex-wrap:wrap">`;
  const sortOpts = [['name','Name'],['sources','Sources'],['cpm','CPM'],['cpc','CPC'],['ctr','CTR']];
  for (const [k,l] of sortOpts) {
    const active = metaSortCol === k;
    h += `<button onclick="sortMetaInd2('${k}')" style="padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid ${active?'var(--accent)':'var(--border)'};background:${active?'rgba(59,130,246,.15)':'transparent'};color:${active?'var(--accent2)':'var(--text3)'}">${l}${active?(metaSortAsc?' \u2191':' \u2193'):''}</button>`;
  }
  h += `</div></div>`;

  if (metaViewMode === 'consensus') {
    for (const [ind, consensus] of sorted) {
      h += renderIndustrySection(ind, consensus);
    }
  } else {
    for (const [ind, consensus] of sorted) {
      h += renderIndustryComparisonSection(ind, consensus);
    }
  }

  mm.innerHTML = h;
}

function renderIndustrySection(ind, c) {
  const id = ind.replace(/[^a-zA-Z0-9]/g, '_');
  const dColor = DISAGREE_COLORS[c._overallDisagreement] || '#64748b';
  const dLabel = DISAGREE_LABELS[c._overallDisagreement] || '';
  const dWidth = DISAGREE_WIDTH[c._overallDisagreement] || 0;

  let h = `<div class="ind-section" data-name="${ind}" data-id="${id}">`;
  // Header
  h += `<div class="ind-header">`;
  h += `<span class="ind-name">${ind}</span>`;
  h += `<span class="source-count-badge">${c._sourceCount} source${c._sourceCount !== 1 ? 's' : ''}</span>`;
  h += `<div class="agreement-meter"><div class="agreement-meter-fill" style="width:${dWidth}%;background:${dColor}"></div></div>`;
  h += `<span class="agreement-label" style="color:${dColor}">${dLabel}</span>`;
  h += dataBadge(c._sourceCount);
  h += `</div>`;

  // Source badges
  h += `<div class="ind-source-badges">`;
  for (const src of c._sources) {
    const color = SRC_COLORS[src] || '#666';
    const geo = SRC_GEO[src] || '';
    const geoStyle = GEO_BADGE_STYLE[geo] || '';
    h += `<span class="ind-src-pill" style="background:${color}22;color:${color}">${src}${geo ? `<span class="geo-tag" style="${geoStyle}">${geo}</span>` : ''}</span>`;
  }
  h += `</div>`;

  // Consensus KPIs
  h += `<div class="consensus-kpis">`;
  const metricLabels = { cpm: 'CPM', cpc: 'CPC', ctr: 'CTR', cpa: 'CPA', cvr: 'CVR', roas: 'ROAS' };
  for (const m of INDUSTRY_METRICS) {
    const d = c[m];
    if (!d) continue;
    const isSingle = d.sources.length <= 1;
    const mColor = DISAGREE_COLORS[d.disagreement] || '#64748b';
    const ciText = (d.sources.length >= 2 && d.value != null) ? `${fmtMetric(d.ci_low, m)} \u2013 ${fmtMetric(d.ci_high, m)}` : (isSingle && d.value != null ? 'Single source' : '');

    // Build tooltip with adjustment details
    let tooltip = d.sources.map(s => {
      let line = s.name + ': ' + fmtMetric(s.value, m);
      if (s.rawValue !== s.value) line += ' (raw: ' + fmtMetric(s.rawValue, m) + ')';
      return line;
    }).join('\n');
    if (d._shrunk) tooltip += '\n[Shrunk toward grand mean: $' + StatEngine._grandMeans[m]?.toFixed(2) + ']';
    if (d.adjustments?.temporalApplied) tooltip += '\n[Temporal adjustment applied]';
    if (d.adjustments?.geoApplied) tooltip += '\n[Geographic correction applied]';
    if (d.adjustments?.imputedCount) tooltip += '\n[' + d.adjustments.imputedCount + ' value(s) imputed via CPM=CPC×CTR]';

    h += `<div class="ckpi${isSingle ? ' single-source' : ''}" title="${tooltip}">`;
    h += `<div class="ckpi-label">${metricLabels[m]}`;
    // Show adjustment badges
    if (d._shrunk) h += ` <span style="font-size:8px;padding:1px 4px;border-radius:3px;background:rgba(168,85,247,.12);color:#c084fc" title="James-Stein shrinkage applied">JS</span>`;
    if (d.adjustments?.imputedCount) h += ` <span style="font-size:8px;padding:1px 4px;border-radius:3px;background:rgba(245,158,11,.12);color:#fbbf24" title="${d.adjustments.imputedCount} imputed">I×${d.adjustments.imputedCount}</span>`;
    h += `</div>`;
    h += `<div class="ckpi-value">${fmtMetric(d.value, m)}</div>`;
    h += `<div class="ckpi-ci-bar"><div class="ckpi-ci-fill" style="width:${DISAGREE_WIDTH[d.disagreement] || 0}%;background:${mColor}"></div></div>`;
    h += `<div class="ckpi-ci-text">${ciText}</div>`;
    h += `<div class="ckpi-sources"><span class="ckpi-dot" style="background:${mColor}"></span>${d.sources.length} source${d.sources.length !== 1 ? 's' : ''}</div>`;
    h += `</div>`;
  }
  h += `</div>`;

  // Expand button
  h += `<button class="ind-expand-btn" onclick="toggleIndBreakdown('${id}')"><span id="iexp-${id}">Source Breakdown \u25BC</span></button>`;

  // Source breakdown (hidden)
  h += `<div class="source-breakdown" id="ibk-${id}">`;
  h += renderSourceBreakdownTable(c);
  h += `</div>`;

  h += `</div>`;
  return h;
}

function renderIndustryComparisonSection(ind, c) {
  const id = ind.replace(/[^a-zA-Z0-9]/g, '_');
  const dColor = DISAGREE_COLORS[c._overallDisagreement] || '#64748b';
  const dLabel = DISAGREE_LABELS[c._overallDisagreement] || '';
  const dWidth = DISAGREE_WIDTH[c._overallDisagreement] || 0;

  let h = `<div class="ind-section" data-name="${ind}" data-id="${id}">`;
  h += `<div class="ind-header">`;
  h += `<span class="ind-name">${ind}</span>`;
  h += `<span class="source-count-badge">${c._sourceCount} source${c._sourceCount !== 1 ? 's' : ''}</span>`;
  h += `<div class="agreement-meter"><div class="agreement-meter-fill" style="width:${dWidth}%;background:${dColor}"></div></div>`;
  h += `<span class="agreement-label" style="color:${dColor}">${dLabel}</span>`;
  h += `</div>`;

  // Comparison table
  h += `<div style="padding:12px 28px 20px;overflow-x:auto">`;
  h += `<table class="comparison-tbl"><thead><tr><th style="text-align:left">Source</th>`;
  const metricLabels = { cpm: 'CPM', cpc: 'CPC', ctr: 'CTR', cpa: 'CPA', cvr: 'CVR', roas: 'ROAS' };
  for (const m of INDUSTRY_METRICS) h += `<th>${metricLabels[m]}</th>`;
  h += `</tr></thead><tbody>`;

  // Each source as a row
  const sourceSet = {};
  for (const row of c._rows) {
    if (!sourceSet[row.source]) sourceSet[row.source] = {};
    for (const m of INDUSTRY_METRICS) {
      if (row[m] != null) sourceSet[row.source][m] = row[m];
    }
  }
  for (const [src, vals] of Object.entries(sourceSet)) {
    const color = SRC_COLORS[src] || '#666';
    h += `<tr><td style="text-align:left"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin-right:6px;vertical-align:middle"></span>${src}</td>`;
    for (const m of INDUSTRY_METRICS) {
      const v = vals[m];
      const consensus = c[m]?.value;
      const dev = (v != null && consensus != null && consensus !== 0) ? ((v - consensus) / Math.abs(consensus) * 100) : null;
      const cls = devCellClass(dev);
      h += `<td class="num"><span class="dev-cell ${cls}">${fmtMetric(v, m)}${dev != null ? ` <small class="${devClass(dev)}">${fmtDev(dev)}</small>` : ''}</span></td>`;
    }
    h += `</tr>`;
  }

  // Consensus row with adjustment indicators
  h += `<tr><td style="text-align:left;font-weight:700">Consensus (IVW+)</td>`;
  for (const m of INDUSTRY_METRICS) {
    let badges = '';
    const d = c[m];
    if (d?.adjustments?.temporalApplied) badges += '<span style="font-size:8px;padding:1px 3px;border-radius:2px;background:rgba(168,85,247,.12);color:#c084fc;margin-left:2px">T</span>';
    if (d?.adjustments?.geoApplied) badges += '<span style="font-size:8px;padding:1px 3px;border-radius:2px;background:rgba(59,130,246,.12);color:#60a5fa;margin-left:2px">G</span>';
    if (d?._shrunk) badges += '<span style="font-size:8px;padding:1px 3px;border-radius:2px;background:rgba(168,85,247,.12);color:#c084fc;margin-left:2px">JS</span>';
    h += `<td class="num" style="font-weight:700">${fmtMetric(c[m]?.value, m)}${badges}</td>`;
  }
  h += `</tr></tbody></table></div>`;

  h += `</div>`;
  return h;
}

function renderSourceBreakdownTable(c) {
  const metricLabels = { cpm: 'CPM', cpc: 'CPC', ctr: 'CTR', cpa: 'CPA', cvr: 'CVR', roas: 'ROAS' };
  let h = `<h4 style="font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Per-Source Values vs Consensus</h4>`;

  // For each metric that has data, show a mini breakdown
  for (const m of INDUSTRY_METRICS) {
    const d = c[m];
    if (!d || d.sources.length === 0) continue;

    h += `<div style="margin-bottom:16px">`;
    h += `<div style="font-size:11px;font-weight:700;color:var(--text2);margin-bottom:6px">${metricLabels[m]} \u2014 Consensus: ${fmtMetric(d.value, m)}</div>`;

    if (d.sources.length >= 2) {
      // Range visualization
      const vals = d.sources.map(s => s.value);
      const minV = Math.min(...vals);
      const maxV = Math.max(...vals);
      const range = maxV - minV || 1;

      h += `<div class="range-viz" style="margin-bottom:8px">`;
      // CI fill
      if (d.ci_low != null && d.ci_high != null) {
        const ciLeft = Math.max(0, ((d.ci_low - minV) / range) * 100);
        const ciRight = Math.min(100, ((d.ci_high - minV) / range) * 100);
        h += `<div class="range-viz-fill" style="left:${ciLeft}%;width:${ciRight - ciLeft}%;background:${DISAGREE_COLORS[d.disagreement]}"></div>`;
      }
      // Source markers
      for (const s of d.sources) {
        const pos = ((s.value - minV) / range) * 100;
        const color = SRC_COLORS[s.name] || '#666';
        h += `<div class="range-viz-marker" style="left:calc(${pos}% - 1.5px);background:${color};width:3px" title="${s.name}: ${fmtMetric(s.value, m)}"></div>`;
      }
      // Consensus line
      const cPos = ((d.value - minV) / range) * 100;
      h += `<div class="range-viz-consensus" style="left:calc(${cPos}% - 1px)" title="Consensus: ${fmtMetric(d.value, m)}"></div>`;
      h += `</div>`;
    }

    // Source detail rows
    h += `<table class="src-breakdown-tbl"><thead><tr><th style="text-align:left">Source</th><th>Raw</th><th>Adjusted</th><th>Deviation</th><th>Weight</th><th></th></tr></thead><tbody>`;
    for (const s of d.sources) {
      const color = SRC_COLORS[s.name] || '#666';
      const arrow = s.deviation > 0 ? '\u2191' : s.deviation < 0 ? '\u2193' : '\u2022';
      h += `<tr>`;
      const sGeo = SRC_GEO[s.name]||''; const sGs = GEO_BADGE_STYLE[sGeo]||'';
      h += `<td style="text-align:left"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin-right:6px;vertical-align:middle"></span>${s.name}${sGeo?` <span class="geo-tag" style="${sGs}">${sGeo}</span>`:''}</td>`;
      // Show raw value
      h += `<td style="color:var(--text3)">${fmtMetric(s.rawValue, m)}</td>`;
      // Show adjusted value (with indicators for what changed)
      let adjTags = '';
      if (s.temporalFactor && s.temporalFactor !== 1.0) adjTags += `<span style="font-size:8px;padding:1px 4px;border-radius:3px;background:rgba(168,85,247,.15);color:#c084fc;margin-left:2px" title="Temporal: ×${s.temporalFactor.toFixed(2)}">T</span>`;
      if (s.geoFactor && s.geoFactor !== 1.0) adjTags += `<span style="font-size:8px;padding:1px 4px;border-radius:3px;background:rgba(59,130,246,.15);color:#60a5fa;margin-left:2px" title="Geo-adjusted to US">G</span>`;
      if (s.imputed) adjTags += `<span style="font-size:8px;padding:1px 4px;border-radius:3px;background:rgba(245,158,11,.15);color:#fbbf24;margin-left:2px" title="Imputed from CPM=CPC×CTR">I</span>`;
      h += `<td>${fmtMetric(s.value, m)}${adjTags}</td>`;
      h += `<td class="${devClass(s.deviation)}">${arrow} ${fmtDev(s.deviation)}</td>`;
      h += `<td style="color:var(--text3)">${s.weight.toFixed(2)}</td>`;
      h += `<td>${s.isOutlier ? '<span class="outlier-flag">OUTLIER</span>' : ''}</td>`;
      h += `</tr>`;
    }
    h += `</tbody></table></div>`;
  }
  return h;
}

function toggleIndBreakdown(id) {
  const el = document.getElementById('ibk-' + id);
  const btn = document.getElementById('iexp-' + id);
  if (el.classList.contains('open')) {
    el.classList.remove('open');
    btn.innerHTML = 'Source Breakdown \u25BC';
  } else {
    el.classList.add('open');
    btn.innerHTML = 'Source Breakdown \u25B2';
  }
}

function sortMetaInd2(col) {
  if (metaSortCol === col) metaSortAsc = !metaSortAsc;
  else { metaSortCol = col; metaSortAsc = col === 'name'; }
  renderMetaIndustry();
  showSubControls(true, 'industry');
}

// ——— BY COUNTRY (spacious full-width sections) ———
function renderMetaCountry(){
  const mm=document.getElementById('metaMain');
  const data = normalizedCountries;
  let sorted = Object.entries(data).sort((a,b) => {
    const va = a[1].cpm?.value ?? -1;
    const vb = b[1].cpm?.value ?? -1;
    return vb - va; // highest CPM first by default
  });

  if (metaSortCol) {
    sorted.sort((a,b) => {
      if (metaSortCol === 'name') return metaSortAsc ? a[0].localeCompare(b[0]) : b[0].localeCompare(a[0]);
      if (metaSortCol === 'sources') return metaSortAsc ? a[1]._sourceCount - b[1]._sourceCount : b[1]._sourceCount - a[1]._sourceCount;
      const va = a[1][metaSortCol]?.value ?? -Infinity;
      const vb = b[1][metaSortCol]?.value ?? -Infinity;
      return metaSortAsc ? va - vb : vb - va;
    });
  }

  let h = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">`;
  h += `<div class="section-title" style="border:none;margin:0;padding:0">Meta Ads by Country <span style="font-size:13px;color:var(--text3);font-weight:400">${sorted.length} countries/regions from ${activeCountrySources.size} sources</span></div>`;
  h += `<div style="display:flex;gap:6px;flex-wrap:wrap">`;
  const sortOpts = [['name','Name'],['sources','Sources'],['cpm','CPM'],['cpc','CPC'],['ctr','CTR']];
  for (const [k,l] of sortOpts) {
    const active = metaSortCol === k;
    h += `<button onclick="sortMetaCtry2('${k}')" style="padding:4px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid ${active?'var(--accent)':'var(--border)'};background:${active?'rgba(59,130,246,.15)':'transparent'};color:${active?'var(--accent2)':'var(--text3)'}">${l}${active?(metaSortAsc?' \u2191':' \u2193'):''}</button>`;
  }
  h += `</div></div>`;

  if (metaViewMode === 'consensus') {
    for (const [country, consensus] of sorted) {
      h += renderCountrySection(country, consensus);
    }
  } else {
    for (const [country, consensus] of sorted) {
      h += renderCountryComparisonSection(country, consensus);
    }
  }

  mm.innerHTML = h;
}

function renderCountrySection(country, c) {
  const id = country.replace(/[^a-zA-Z0-9]/g, '_');
  const dColor = DISAGREE_COLORS[c._overallDisagreement] || '#64748b';
  const dLabel = DISAGREE_LABELS[c._overallDisagreement] || '';
  const dWidth = DISAGREE_WIDTH[c._overallDisagreement] || 0;

  // Color CPM by tier
  const cpm = c.cpm?.value;
  let cpmColor = 'var(--text)';
  if (cpm != null) {
    if (cpm >= 15) cpmColor = 'var(--red)';
    else if (cpm >= 8) cpmColor = 'var(--orange)';
    else if (cpm >= 3) cpmColor = 'var(--text)';
    else cpmColor = 'var(--green)';
  }

  let h = `<div class="ctry-section" data-name="${country}" data-id="${id}">`;
  h += `<div class="ctry-header">`;
  h += `<span class="ctry-name">${country}</span>`;
  h += `<span class="source-count-badge">${c._sourceCount} source${c._sourceCount !== 1 ? 's' : ''}</span>`;
  if (c._sourceCount > 1) {
    h += `<div class="agreement-meter"><div class="agreement-meter-fill" style="width:${dWidth}%;background:${dColor}"></div></div>`;
    h += `<span class="agreement-label" style="color:${dColor}">${dLabel}</span>`;
  }
  h += dataBadge(c._sourceCount);
  // Source badges inline
  for (const src of c._sources) {
    const color = SRC_COLORS[src] || '#666';
    const geo = SRC_GEO[src] || '';
    const geoStyle = GEO_BADGE_STYLE[geo] || '';
    h += `<span class="ind-src-pill" style="background:${color}22;color:${color};font-size:10px">${src}${geo ? `<span class="geo-tag" style="${geoStyle}">${geo}</span>` : ''}</span>`;
  }
  h += `</div>`;

  // KPIs
  h += `<div class="ctry-kpis">`;
  const metricLabels = { cpm: 'CPM', cpc: 'CPC', ctr: 'CTR' };
  for (const m of COUNTRY_METRICS) {
    const d = c[m];
    if (!d) continue;
    const isSingle = d.sources.length <= 1;
    const mColor = DISAGREE_COLORS[d.disagreement] || '#64748b';
    const valColor = m === 'cpm' ? cpmColor : 'var(--text)';
    const ciText = (d.sources.length >= 2 && d.value != null) ? `${fmtMetric(d.ci_low, m)} \u2013 ${fmtMetric(d.ci_high, m)}` : (isSingle && d.value != null ? 'Single source' : '');

    h += `<div class="ckpi${isSingle ? ' single-source' : ''}">`;
    h += `<div class="ckpi-label">${metricLabels[m]}</div>`;
    h += `<div class="ckpi-value" style="color:${valColor}">${fmtMetric(d.value, m)}</div>`;
    h += `<div class="ckpi-ci-bar"><div class="ckpi-ci-fill" style="width:${DISAGREE_WIDTH[d.disagreement] || 0}%;background:${mColor}"></div></div>`;
    h += `<div class="ckpi-ci-text">${ciText}</div>`;
    h += `<div class="ckpi-sources"><span class="ckpi-dot" style="background:${mColor}"></span>${d.sources.length} source${d.sources.length !== 1 ? 's' : ''}</div>`;
    h += `</div>`;
  }
  h += `</div>`;

  // Expand button (only if multiple sources)
  if (c._sourceCount > 1) {
    h += `<button class="ctry-expand-btn" onclick="toggleCtryBreakdown('${id}')"><span id="cexp-${id}">Source Breakdown \u25BC</span></button>`;
    h += `<div class="ctry-breakdown" id="cbk-${id}">`;
    h += renderCountryBreakdownTable(c);
    h += `</div>`;
  }

  h += `</div>`;
  return h;
}

function renderCountryComparisonSection(country, c) {
  const id = country.replace(/[^a-zA-Z0-9]/g, '_');
  const dColor = DISAGREE_COLORS[c._overallDisagreement] || '#64748b';

  let h = `<div class="ctry-section" data-name="${country}" data-id="${id}">`;
  h += `<div class="ctry-header">`;
  h += `<span class="ctry-name">${country}</span>`;
  h += `<span class="source-count-badge">${c._sourceCount} source${c._sourceCount !== 1 ? 's' : ''}</span>`;
  h += dataBadge(c._sourceCount);
  h += `</div>`;

  h += `<div style="padding:12px 24px 20px;overflow-x:auto">`;
  h += `<table class="comparison-tbl"><thead><tr><th style="text-align:left">Source</th>`;
  const metricLabels = { cpm: 'CPM', cpc: 'CPC', ctr: 'CTR' };
  for (const m of COUNTRY_METRICS) h += `<th>${metricLabels[m]}</th>`;
  h += `</tr></thead><tbody>`;

  const sourceSet = {};
  for (const row of c._rows) {
    if (!sourceSet[row.source]) sourceSet[row.source] = {};
    for (const m of COUNTRY_METRICS) {
      if (row[m] != null) sourceSet[row.source][m] = row[m];
    }
  }
  for (const [src, vals] of Object.entries(sourceSet)) {
    const color = SRC_COLORS[src] || '#666';
    h += `<tr><td style="text-align:left"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin-right:6px;vertical-align:middle"></span>${src}</td>`;
    for (const m of COUNTRY_METRICS) {
      const v = vals[m];
      const consensus = c[m]?.value;
      const dev = (v != null && consensus != null && consensus !== 0) ? ((v - consensus) / Math.abs(consensus) * 100) : null;
      const cls = devCellClass(dev);
      h += `<td class="num"><span class="dev-cell ${cls}">${fmtMetric(v, m)}${dev != null ? ` <small class="${devClass(dev)}">${fmtDev(dev)}</small>` : ''}</span></td>`;
    }
    h += `</tr>`;
  }
  h += `<tr><td style="text-align:left;font-weight:700">Consensus (IVW)</td>`;
  for (const m of COUNTRY_METRICS) h += `<td class="num" style="font-weight:700">${fmtMetric(c[m]?.value, m)}</td>`;
  h += `</tr></tbody></table></div>`;

  h += `</div>`;
  return h;
}

function renderCountryBreakdownTable(c) {
  const metricLabels = { cpm: 'CPM', cpc: 'CPC', ctr: 'CTR' };
  let h = '';
  for (const m of COUNTRY_METRICS) {
    const d = c[m];
    if (!d || d.sources.length < 2) continue;
    h += `<div style="margin-bottom:12px">`;
    h += `<div style="font-size:11px;font-weight:700;color:var(--text2);margin-bottom:6px">${metricLabels[m]} \u2014 Consensus: ${fmtMetric(d.value, m)}</div>`;

    const vals = d.sources.map(s => s.value);
    const minV = Math.min(...vals);
    const maxV = Math.max(...vals);
    const range = maxV - minV || 1;
    h += `<div class="range-viz" style="margin-bottom:6px">`;
    if (d.ci_low != null && d.ci_high != null) {
      const ciLeft = Math.max(0, ((d.ci_low - minV) / range) * 100);
      const ciRight = Math.min(100, ((d.ci_high - minV) / range) * 100);
      h += `<div class="range-viz-fill" style="left:${ciLeft}%;width:${ciRight - ciLeft}%;background:${DISAGREE_COLORS[d.disagreement]}"></div>`;
    }
    for (const s of d.sources) {
      const pos = ((s.value - minV) / range) * 100;
      const color = SRC_COLORS[s.name] || '#666';
      h += `<div class="range-viz-marker" style="left:calc(${pos}% - 1.5px);background:${color};width:3px" title="${s.name}: ${fmtMetric(s.value, m)}"></div>`;
    }
    const cPos = ((d.value - minV) / range) * 100;
    h += `<div class="range-viz-consensus" style="left:calc(${cPos}% - 1px)" title="Consensus"></div>`;
    h += `</div>`;

    for (const s of d.sources) {
      const color = SRC_COLORS[s.name] || '#666';
      const arrow = s.deviation > 0 ? '\u2191' : s.deviation < 0 ? '\u2193' : '';
      h += `<div style="display:flex;align-items:center;gap:10px;font-size:12px;padding:3px 0">`;
      h += `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color}"></span>`;
      h += `<span style="width:70px;color:var(--text2)">${s.name}</span>`;
      h += `<span style="width:60px;font-weight:600">${fmtMetric(s.value, m)}</span>`;
      h += `<span class="${devClass(s.deviation)}" style="width:50px">${arrow} ${fmtDev(s.deviation)}</span>`;
      h += `${s.isOutlier ? '<span class="outlier-flag">OUTLIER</span>' : ''}`;
      h += `</div>`;
    }
    h += `</div>`;
  }
  return h;
}

function toggleCtryBreakdown(id) {
  const el = document.getElementById('cbk-' + id);
  const btn = document.getElementById('cexp-' + id);
  if (el.classList.contains('open')) {
    el.classList.remove('open');
    btn.innerHTML = 'Source Breakdown \u25BC';
  } else {
    el.classList.add('open');
    btn.innerHTML = 'Source Breakdown \u25B2';
  }
}

function sortMetaCtry2(col) {
  if (metaSortCol === col) metaSortAsc = !metaSortAsc;
  else { metaSortCol = col; metaSortAsc = col === 'name'; }
  renderMetaCountry();
  showSubControls(true, 'country');
}

// ——— TRENDS (unchanged) ———
function renderMetaTrends(){
  const mm=document.getElementById('metaMain');
  let h=`<div class="section-title">Meta Ads Weekly Trends <span style="font-size:12px;color:var(--text3);font-weight:400">(Revealbot/Birch, US campaigns, Feb 2025 - Feb 2026)</span></div>`;
  h+=`<div class="meta-chart-grid">`;
  h+=`<div class="meta-chart-box"><h5>Facebook CPM (Monthly Avg)</h5><canvas id="mc-fb-cpm"></canvas></div>`;
  h+=`<div class="meta-chart-box"><h5>Facebook CPC (Monthly Avg)</h5><canvas id="mc-fb-cpc"></canvas></div>`;
  h+=`<div class="meta-chart-box"><h5>Instagram CPM (Monthly Avg)</h5><canvas id="mc-ig-cpm"></canvas></div>`;
  h+=`<div class="meta-chart-box"><h5>Facebook vs Instagram CPM</h5><canvas id="mc-fbig-cpm"></canvas></div>`;
  h+=`</div>`;
  h+=`<div class="section-title" style="margin-top:8px">Monthly Averages (USD)</div>`;
  h+=`<table class="data-tbl"><thead><tr><th>Month</th><th>FB CPM</th><th>FB CPC</th><th>IG CPM</th><th>FB CPM (Traffic)</th><th>FB CPM (Lead Gen)</th><th>FB CPM (Catalog)</th></tr></thead><tbody>`;
  const rbTraffic=[4.96,4.89,3.97,4.44,4.12,3.12,4.91,4.74,6.04,6.32,6.31,5.48,8.78];
  const rbLeadGen=[23.23,16.57,25.30,22.07,24.34,21.50,24.50,17.81,28.65,19.55,30.29,25.44,17.53];
  const rbCatalog=[11.15,17.38,15.34,14.15,11.49,13.92,15.35,14.46,13.50,9.83,9.42,14.82,16.19];
  for(let i=0;i<RB_MONTHS.length;i++){
    h+=`<tr><td>${RB_MONTHS[i]}</td><td class="num">$${RB_FB_CPM[i].toFixed(2)}</td><td class="num">$${RB_FB_CPC[i].toFixed(2)}</td><td class="num">$${RB_IG_CPM[i].toFixed(2)}</td><td class="num">$${rbTraffic[i].toFixed(2)}</td><td class="num">$${rbLeadGen[i].toFixed(2)}</td><td class="num">$${rbCatalog[i].toFixed(2)}</td></tr>`;
  }
  h+=`</tbody></table>`;
  mm.innerHTML=h;
  requestAnimationFrame(()=>{
    function lineC(id,data,color,label,prefix){
      destroyChart(id);const c=document.getElementById(id);if(!c)return;
      charts[id]=new Chart(c.getContext('2d'),{type:'line',data:{labels:RB_MONTHS,datasets:[{label,data,borderColor:color,backgroundColor:color+'22',borderWidth:2,fill:true,tension:.3,pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>prefix+c.parsed.y?.toFixed(2)}}},scales:{x:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'#1e293b44'}},y:{ticks:{color:'#475569',font:{size:10},callback:v=>prefix+v},grid:{color:'#1e293b44'}}}}});
    }
    lineC('mc-fb-cpm',RB_FB_CPM,'#1877f2','FB CPM','$');
    lineC('mc-fb-cpc',RB_FB_CPC,'#22c55e','FB CPC','$');
    lineC('mc-ig-cpm',RB_IG_CPM,'#e4405f','IG CPM','$');
    destroyChart('mc-fbig-cpm');const c4=document.getElementById('mc-fbig-cpm');if(c4){
      charts['mc-fbig-cpm']=new Chart(c4.getContext('2d'),{type:'line',data:{labels:RB_MONTHS,datasets:[
        {label:'Facebook',data:RB_FB_CPM,borderColor:'#1877f2',backgroundColor:'#1877f222',borderWidth:2,fill:false,tension:.3,pointRadius:3},
        {label:'Instagram',data:RB_IG_CPM,borderColor:'#e4405f',backgroundColor:'#e4405f22',borderWidth:2,fill:false,tension:.3,pointRadius:3}
      ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}},scales:{x:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'#1e293b44'}},y:{ticks:{color:'#475569',font:{size:10},callback:v=>'$'+v},grid:{color:'#1e293b44'}}},interaction:{mode:'index',intersect:false}}});
    }
  });
}

// ——— OBJECTIVES (unchanged) ———
function renderMetaObjectives(){
  const mm=document.getElementById('metaMain');
  let h=`<div class="section-title">Performance by Campaign Objective & Placement</div>`;
  h+=`<div class="meta-chart-grid">`;
  h+=`<div class="meta-chart-box"><h5>CTR by Campaign Objective (Databox)</h5><canvas id="mc-obj-ctr"></canvas></div>`;
  h+=`<div class="meta-chart-box"><h5>CTR by Placement (Databox)</h5><canvas id="mc-place-ctr"></canvas></div>`;
  h+=`<div class="meta-chart-box"><h5>CPM by Objective - Feb 2026 (Revealbot)</h5><canvas id="mc-obj-cpm"></canvas></div>`;
  h+=`<div class="meta-chart-box"><h5>CPC by Objective - Latest (Revealbot)</h5><canvas id="mc-obj-cpc"></canvas></div>`;
  h+=`</div>`;
  h+=`<div class="section-title" style="margin-top:8px">Campaign Objective Benchmarks</div>`;
  h+=`<table class="data-tbl"><thead><tr><th>Objective</th><th>CTR (Databox)</th><th>CPM Feb 26 (Revealbot)</th><th>Notes</th></tr></thead><tbody>`;
  const objNotes={'Lead Gen':'Highest CTR but highest CPM','Traffic':'Cheapest CPC ($0.22)','Conversions':'Most used objective','Brand Awareness':'Cheapest CPM ($2.24)','Video Views':'Volatile costs','Engagement':'Good for social proof','Reach':'Widest audience, lowest CTR'};
  for(let i=0;i<OBJ_CTR.length;i++){
    const[name,ctr]=OBJ_CTR[i];
    const cpmIdx=RB_OBJ_CPM_LABELS.findIndex(l=>l.startsWith(name.split(' ')[0]));
    const cpm=cpmIdx>=0?'$'+RB_OBJ_CPM_LATEST[cpmIdx].toFixed(2):'\u2014';
    h+=`<tr><td><strong>${name}</strong></td><td class="num">${ctr.toFixed(2)}%</td><td class="num">${cpm}</td><td style="color:var(--text3);font-size:12px">${objNotes[name]||''}</td></tr>`;
  }
  h+=`</tbody></table>`;
  h+=`<div class="section-title" style="margin-top:20px">Placement CTR Benchmarks (Databox)</div>`;
  h+=`<table class="data-tbl"><thead><tr><th>Placement</th><th>CTR</th><th>Relative</th></tr></thead><tbody>`;
  const maxP=Math.max(...PLACE_CTR.map(p=>p[1]));
  for(const[name,ctr]of PLACE_CTR){
    const pct=Math.round(ctr/maxP*100);
    h+=`<tr><td><strong>${name}</strong></td><td class="num">${ctr.toFixed(2)}%</td><td><div style="background:var(--accent);height:14px;width:${pct}%;border-radius:3px;min-width:2px"></div></td></tr>`;
  }
  h+=`</tbody></table>`;
  mm.innerHTML=h;
  requestAnimationFrame(()=>{
    barChart('mc-obj-ctr',OBJ_CTR.map(o=>o[0]),OBJ_CTR.map(o=>o[1]),'#3b82f6','%');
    barChart('mc-place-ctr',PLACE_CTR.map(p=>p[0]),PLACE_CTR.map(p=>p[1]),'#a78bfa','%');
    barChart('mc-obj-cpm',RB_OBJ_CPM_LABELS,RB_OBJ_CPM_LATEST,'#f59e0b','$');
    const rbObjCpcLatest=[0.20,0.00,1.53,0.51,1.41,0.22,0.00];
    barChart('mc-obj-cpc',RB_OBJ_CPM_LABELS,rbObjCpcLatest,'#22c55e','$');
  });
}

// =============================================
// TAB SWITCHING
// =============================================
document.getElementById('mainTabs').addEventListener('click',e=>{
  const b=e.target.closest('.main-tab');if(!b)return;
  document.querySelectorAll('.main-tab').forEach(t=>t.classList.remove('active'));
  b.classList.add('active');
  const tab=b.dataset.tab;
  document.getElementById('twView').style.display=tab==='tw'?'':'none';
  document.getElementById('metaView').style.display=tab==='meta'?'':'none';
  document.getElementById('twControls').style.display=tab==='tw'?'contents':'none';
  if(tab==='meta'){metaSortCol=null;metaSortAsc=true;renderMeta()}
});

document.getElementById('metaNav').addEventListener('click',e=>{
  const b=e.target.closest('.meta-nav-btn');if(!b)return;
  document.querySelectorAll('.meta-nav-btn').forEach(t=>t.classList.remove('active'));
  b.classList.add('active');
  metaView=b.dataset.meta;metaSortCol=null;metaSortAsc=true;
  renderMeta();
});

// =============================================
// INIT
// =============================================
(async()=>{
  try{
    await loadAll();
    // Build normalized data
    normalizedIndustries = buildNormalizedIndustries();
    normalizedCountries = buildNormalizedCountries();
    console.log(`StatEngine initialized: ${Object.keys(normalizedIndustries).length} industries, ${Object.keys(normalizedCountries).length} countries`);
    document.getElementById('loading').style.display='none';
    document.getElementById('main').style.display='block';
    render();
  }catch(err){
    document.getElementById('loading').innerHTML=`<div style="color:#ef4444">Error: ${err.message}<br><br>Serve via HTTP: python3 -m http.server 8765</div>`;
    console.error(err);
  }
})();
</script>
</body>
</html>
