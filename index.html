<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Industry Benchmarks Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0b0f19;--bg2:#111827;--bg3:#1f2937;--bg4:#374151;
  --border:#1e293b;--border2:#334155;
  --text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
  --accent:#3b82f6;--accent2:#60a5fa;
  --green:#22c55e;--green2:#16a34a;--green-bg:rgba(34,197,94,.1);
  --orange:#f59e0b;--orange-bg:rgba(245,158,11,.1);
  --red:#ef4444;--red-bg:rgba(239,68,68,.1);
  --purple:#a78bfa;
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* Top bar */
.topbar{position:sticky;top:0;z-index:100;background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.topbar h1{font-size:18px;font-weight:700;white-space:nowrap}
.region-toggle{display:flex;background:var(--bg);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.region-btn{padding:7px 16px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--text3);transition:all .15s}
.region-btn.active{background:var(--accent);color:#fff}
.region-btn:hover:not(.active){background:var(--bg3);color:var(--text2)}
.search-wrap{flex:1;min-width:200px;max-width:400px;position:relative}
.search-wrap input{width:100%;padding:8px 12px 8px 36px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none}
.search-wrap input:focus{border-color:var(--accent)}
.search-wrap::before{content:'\1F50D';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:12px;opacity:.5}
.stats{display:flex;gap:16px;font-size:12px;color:var(--text3);margin-left:auto}
.stats strong{color:var(--text2)}

/* Channel group bar */
.channel-bar{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.channel-bar-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-right:4px;font-weight:600}
.ch-group{display:flex;align-items:center;gap:2px;background:var(--bg);border-radius:8px;padding:3px;border:1px solid var(--border)}
.ch-group-btn{padding:5px 12px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;border:none;background:transparent;color:var(--text3);transition:all .15s;white-space:nowrap}
.ch-group-btn.active{background:var(--bg3);color:var(--text);border:1px solid var(--border2)}
.ch-group-btn:hover:not(.active){color:var(--text2)}
.ch-sub{display:flex;gap:4px;margin-left:4px;flex-wrap:wrap}
.ch-sub-btn{padding:3px 10px;border-radius:12px;font-size:11px;cursor:pointer;border:1px solid transparent;transition:all .15s;white-space:nowrap}
.ch-sub-btn.selected{border-color:rgba(255,255,255,.3);box-shadow:0 0 4px rgba(255,255,255,.1)}
.ch-sub-btn:hover{opacity:.8}

/* Loading */
.loading{text-align:center;padding:80px;color:var(--text3)}
.spinner{display:inline-block;width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Main */
.main{padding:24px;max-width:1600px;margin:0 auto}

/* Super-category */
.super-cat{margin-bottom:28px}
.super-cat-hdr{display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;user-select:none}
.super-cat-hdr:hover h2{color:var(--accent2)}
.super-cat-hdr .arr{font-size:11px;color:var(--text3);transition:transform .2s;width:16px}
.super-cat-hdr.collapsed .arr{transform:rotate(-90deg)}
.super-cat-hdr h2{font-size:15px;font-weight:600}
.super-cat-hdr .cnt{font-size:11px;color:var(--text3);padding:2px 8px;background:var(--bg3);border-radius:10px}

/* Cards grid — 2 columns, larger */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(580px,1fr));gap:16px}
.grid.hidden{display:none}

/* Card */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:border-color .2s}
.card:hover{border-color:var(--border2)}
.card-top{padding:20px 24px 16px}
.card-top h3{font-size:17px;font-weight:700;margin-bottom:4px}
.card-top .card-channels{font-size:11px;color:var(--text3);margin-bottom:14px}

/* Metrics grid — 2 rows of 4 */
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px}
.metric{background:var(--bg);border-radius:8px;padding:12px;text-align:center;border:1px solid var(--border)}
.metric .label{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--text3);margin-bottom:4px;font-weight:600}
.metric .val{font-size:22px;font-weight:800;line-height:1.1}
.metric .sub{font-size:10px;color:var(--text3);margin-top:3px}
.metric.highlight{border-color:var(--green);background:var(--green-bg)}
.metric.warn{border-color:var(--orange);background:var(--orange-bg)}
.metric.bad{border-color:var(--red);background:var(--red-bg)}

/* Spark row */
.spark-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:6px}
.spark-box{background:var(--bg);border-radius:8px;padding:10px 12px}
.spark-box .spark-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;margin-bottom:4px}
.spark-box canvas{height:50px!important;width:100%!important}

/* Expand */
.expand-btn{display:flex;align-items:center;justify-content:center;width:100%;padding:10px;background:none;border:none;border-top:1px solid var(--border);color:var(--text3);font-size:12px;cursor:pointer;transition:all .15s;font-weight:500}
.expand-btn:hover{color:var(--accent2);background:rgba(59,130,246,.05)}

/* Detail */
.detail{display:none;padding:20px 24px;border-top:1px solid var(--border);background:var(--bg)}
.detail.open{display:block}
.detail h4{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.detail-section{margin-bottom:20px}
.tbl{width:100%;border-collapse:collapse;font-size:12px;display:block;overflow-x:auto}
.tbl th,.tbl td{padding:6px 8px;text-align:right;white-space:nowrap}
.tbl th{color:var(--text3);font-weight:500;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg)}
.tbl td:first-child,.tbl th:first-child{text-align:left}
.tbl tr:hover td{background:var(--bg2)}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.chart-box{background:var(--bg2);border-radius:8px;padding:14px}
.chart-box h5{font-size:11px;color:var(--text3);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.chart-box canvas{width:100%!important;height:170px!important}

/* No data badge */
.no-us{display:inline-block;padding:2px 8px;font-size:10px;background:var(--bg3);color:var(--text3);border-radius:4px;margin-left:8px}

/* Responsive */
@media(max-width:768px){
  .grid{grid-template-columns:1fr}
  .metrics{grid-template-columns:repeat(2,1fr)}
  .chart-row{grid-template-columns:1fr}
  .topbar{padding:10px 16px}
  .channel-bar{padding:8px 16px}
  .main{padding:16px}
  .stats{display:none}
}
</style>
</head>
<body>

<div class="topbar">
  <h1>Industry Benchmarks</h1>
  <div class="region-toggle" id="regionToggle">
    <button class="region-btn active" data-region="global">All Markets</button>
    <button class="region-btn" data-region="us">$1M-$10M GMV</button>
  </div>
  <div class="search-wrap"><input type="text" id="searchInput" placeholder="Search industries..."></div>
  <div class="stats">
    <span><strong id="sI">0</strong> Industries</span>
    <span><strong id="sC">0</strong> Channels</span>
    <span><strong id="sR">0</strong> Records</span>
  </div>
</div>

<div class="channel-bar">
  <span class="channel-bar-label">Channels:</span>
  <div class="ch-group" id="chGroupBar">
    <button class="ch-group-btn active" data-group="all">All</button>
    <button class="ch-group-btn" data-group="social">Social</button>
    <button class="ch-group-btn" data-group="search">Search</button>
    <button class="ch-group-btn" data-group="native">Native</button>
    <button class="ch-group-btn" data-group="marketplace">Marketplace</button>
    <button class="ch-group-btn" data-group="other">Other</button>
  </div>
  <div class="ch-sub" id="chSubBar"></div>
</div>

<div class="loading" id="loading"><div class="spinner"></div><div>Loading benchmarks...</div></div>
<div class="main" id="main" style="display:none"></div>

<script>
// =========== CONFIG ===========
const CHANNEL_GROUPS = {
  social: { label: 'Social', channels: ['Meta','TikTok','Snapchat','Pinterest Ads','Reddit','Twitter'], colors: { Meta:'#1877f2', TikTok:'#fe2c55', Snapchat:'#fffc00', 'Pinterest Ads':'#e60023', Reddit:'#ff4500', Twitter:'#1d9bf0' }},
  search: { label: 'Search', channels: ['Google Ads','Microsoft Ads'], colors: { 'Google Ads':'#4285f4', 'Microsoft Ads':'#00a4ef' }},
  native: { label: 'Native', channels: ['Taboola','Outbrain','Criteo','StackAdapt','Adroll'], colors: { Taboola:'#005baa', Outbrain:'#e6420b', Criteo:'#f4811f', StackAdapt:'#6c3dc7', Adroll:'#0dadf1' }},
  marketplace: { label: 'Marketplace', channels: ['Amazon'], colors: { Amazon:'#ff9900' }},
  other: { label: 'Other', channels: ['Axon','AfterSell','Vibe','Mountain','Yotpo SMS and Email'], colors: { Axon:'#00c4b4', AfterSell:'#7c3aed', Vibe:'#6366f1', Mountain:'#22c55e', 'Yotpo SMS and Email':'#3b82f6' }}
};

const ALL_CHANNELS_COLOR = {};
for (const g of Object.values(CHANNEL_GROUPS)) for (const [c,col] of Object.entries(g.colors)) ALL_CHANNELS_COLOR[c] = col;

const SUPER_CATEGORIES = {
  'Health & Medical':['health_and_beauty','health_and_wellness','healthcare_providers','medical_devices_and_equipment','pharmaceuticals_and_biotech','senior_care'],
  'Finance & Business':['accounting_and_tax_services','financial_services','insurance','investment_and_wealth_management','consulting_and_professional_services','business_supplies_and_equipment'],
  'Tech & Software':['software_and_saas','technology_services','consumer_electronics','emerging_technology','telecommunications','gaming_and_apps'],
  'Retail & Commerce':['apparel_and_accessories','lifestyle_and_boutique','internet_and_ecommerce','toys_art_and_collectibles','baby','sports_and_outdoors'],
  'Home & Living':['home_and_garden','food_and_beverage','pets_and_animals','agriculture_and_food_production'],
  'Travel & Hospitality':['hotels_and_accommodation','travel_accessories_and_luggage','transportation_services','events_and_venues'],
  'Media & Entertainment':['entertainment','media_and_publishing','arts_and_culture','books_and_music'],
  'Education & Training':['elearning_and_online_courses','professional_training_and_coaching'],
  'Professional Services':['legal_services','hr_and_recruiting','marketing_and_advertising','real_estate','construction_and_engineering','manufacturing'],
  'Other':['nonprofit_and_philanthropy','energy_and_utilities','dating_and_personal_services','automotive','other']
};

const MONTH_ORDER = {};
const MN = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
for(let y=22;y<=26;y++) for(let m=0;m<12;m++) MONTH_ORDER[`${MN[m]} ${y}`]=y*12+m;
function sortM(a,b){return(MONTH_ORDER[a]||0)-(MONTH_ORDER[b]||0)}
const DAY_NAMES=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

// =========== STATE ===========
let currentRegion = 'global';
let currentGroup = 'all';
let selectedChannels = new Set(); // empty = all in group
let globalData = {}; // industry -> channel -> month -> metrics
let usData = {};     // industry -> channel -> metrics (single snapshot)
let dowData = {};
let womData = {};
let domData = {};
let allIndustries = new Set();
let allChannels = new Set();
let totalRows = 0;
const charts = {};

// =========== PARSE ===========
function cleanNum(v){
  if(!v||v===''||v==='-') return null;
  let s=String(v).replace(/[$,%x]/g,'').replace(/,/g,'').trim();
  let n=parseFloat(s); return isNaN(n)?null:n;
}
function parseRow(r){return{cpm:cleanNum(r.CPM),cpc:cleanNum(r.CPC),ctr:cleanNum(r.CTR),cpa:cleanNum(r.CPA),cvr:cleanNum(r.Cvr),roas:cleanNum(r.ROAS),aov:cleanNum(r.AOV),mer:cleanNum(r.Mer)}}
function nest(o,ks){let c=o;for(const k of ks){if(!c[k])c[k]={};c=c[k]}return c}

async function loadCSV(f){const r=await fetch(f);const t=await r.text();return Papa.parse(t,{header:true,delimiter:'\t',skipEmptyLines:true}).data}

async function loadAll(){
  const [monthly,us,dow,wom,dom] = await Promise.all([
    loadCSV('monthly_benchmarks.csv'),
    loadCSV('us_benchmarks.csv'),
    loadCSV('benchmarks_by_day_of_week.csv'),
    loadCSV('benchmarks_by_week_of_month.csv'),
    loadCSV('benchmarks_by_day_of_month.csv'),
  ]);
  for(const r of monthly){
    const i=r.Industry,c=r.Channel,m=r.Month;
    if(!i||!c||!m)continue;
    allIndustries.add(i);allChannels.add(c);totalRows++;
    nest(globalData,[i,c])[m]=parseRow(r);
  }
  for(const r of us){
    const i=r.Industry,c=r.Channel;
    if(!i||!c)continue;totalRows++;
    nest(usData,[i])[c]=parseRow(r);
  }
  for(const r of dow){const i=r.Industry,c=r.Channel,d=r.Day_of_Week;if(!i||!c||!d)continue;totalRows++;nest(dowData,[i,c])[d]=parseRow(r)}
  for(const r of wom){const i=r.Industry,c=r.Channel,w=r.Week_of_Month;if(!i||!c||!w)continue;totalRows++;nest(womData,[i,c])[w]=parseRow(r)}
  for(const r of dom){const i=r.Industry,c=r.Channel,d=r.Day_of_Month;if(!i||!c||!d)continue;totalRows++;nest(domData,[i,c])[d]=parseRow(r)}
}

// =========== DATA ACCESS ===========
function getActiveChannels(){
  if(currentGroup==='all') return null; // all channels
  const grp = CHANNEL_GROUPS[currentGroup];
  if(!grp) return null;
  if(selectedChannels.size>0) return [...selectedChannels];
  return grp.channels;
}

function filterChannels(channelObj){
  const active = getActiveChannels();
  if(!active) return channelObj;
  const out={};
  for(const c of active) if(channelObj[c]) out[c]=channelObj[c];
  return out;
}

function avgMetrics(arr){
  const r={};
  for(const k of ['cpm','cpc','ctr','cpa','cvr','roas','aov','mer']){
    const v=arr.map(m=>m[k]).filter(v=>v!=null);
    r[k]=v.length?v.reduce((a,b)=>a+b,0)/v.length:null;
  }
  return r;
}

function getLatestGlobal(industry){
  const chs=globalData[industry];if(!chs)return null;
  const filtered=filterChannels(chs);
  const months=new Set();
  for(const c in filtered)for(const m in filtered[c])months.add(m);
  const sorted=[...months].sort(sortM);
  if(!sorted.length)return null;
  const latest=sorted[sorted.length-1];
  const mets=[];
  for(const c in filtered)if(filtered[c][latest])mets.push(filtered[c][latest]);
  return mets.length?avgMetrics(mets):null;
}

function getLatestUS(industry){
  const chs=usData[industry];if(!chs)return null;
  const filtered=filterChannels(chs);
  const mets=Object.values(filtered);
  return mets.length?avgMetrics(mets):null;
}

function getLatestMetrics(industry){
  return currentRegion==='us'?getLatestUS(industry):getLatestGlobal(industry);
}

function getChannelsFor(industry){
  if(currentRegion==='us'){
    return usData[industry]?Object.keys(usData[industry]).sort():[];
  }
  return globalData[industry]?Object.keys(globalData[industry]).sort():[];
}

function hasSegmentData(industry){ return !!(usData[industry]&&Object.keys(usData[industry]).length) }

function getGlobalMonthlyTrend(industry,metric,n){
  const chs=globalData[industry];if(!chs)return[];
  const filtered=filterChannels(chs);
  const months=new Set();
  for(const c in filtered)for(const m in filtered[c])months.add(m);
  const sorted=[...months].sort(sortM).slice(-n);
  return sorted.map(m=>{
    const mets=[];
    for(const c in filtered)if(filtered[c][m])mets.push(filtered[c][m]);
    const avg=mets.length?avgMetrics(mets):null;
    return{month:m,value:avg?avg[metric]:null};
  });
}

function getTimeDim(store,industry,keys){
  const chs=store[industry];if(!chs)return keys.map(()=>null);
  const filtered=filterChannels(chs);
  return keys.map(k=>{
    const mets=[];
    for(const c in filtered)if(filtered[c]&&filtered[c][k])mets.push(filtered[c][k]);
    return mets.length?avgMetrics(mets):null;
  });
}

// =========== FORMAT ===========
function fmt(v,t){
  if(v==null)return'—';
  switch(t){case'$':return'$'+v.toFixed(2);case'%':return v.toFixed(2)+'%';case'x':return v.toFixed(2)+'x';default:return v.toFixed(2)}
}
function fmtInd(s){
  return s.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())
    .replace(/\bAnd\b/g,'&').replace(/\bSaas\b/g,'SaaS').replace(/\bHr\b/g,'HR')
    .replace(/\bElearning\b/g,'eLearning').replace(/\bEcommerce\b/g,'eCommerce');
}

function metricClass(metric,value){
  if(value==null)return'';
  if(metric==='roas') return value>=2.5?'highlight':value>=1?'warn':'bad';
  if(metric==='mer') return value<0.5?'highlight':value<1?'warn':'bad';
  return'';
}

// =========== CHARTS ===========
function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id]}}

function sparkline(id,data,color,label){
  destroyChart(id);const c=document.getElementById(id);if(!c)return;
  charts[id]=new Chart(c.getContext('2d'),{type:'line',data:{labels:data.map(d=>d.month||d.label||''),datasets:[{data:data.map(d=>d.value),borderColor:color||'#3b82f6',backgroundColor:(color||'#3b82f6')+'22',borderWidth:2,fill:true,tension:.35,pointRadius:0,pointHitRadius:8}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>(label||'')+c.parsed.y?.toFixed(2)}}},scales:{x:{display:false},y:{display:false}},interaction:{mode:'index',intersect:false}}});
}

function barChart(id,labels,values,color,valFmt){
  destroyChart(id);const c=document.getElementById(id);if(!c)return;
  charts[id]=new Chart(c.getContext('2d'),{type:'bar',data:{labels,datasets:[{data:values,backgroundColor:color+'88',borderColor:color,borderWidth:1,borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>fmt(c.parsed.y,valFmt)}}},scales:{x:{ticks:{color:'#64748b',font:{size:10}},grid:{display:false}},y:{ticks:{color:'#475569',font:{size:10}},grid:{color:'#1e293b44'}}}}});
}

// =========== RENDER ===========
function render(){
  document.getElementById('sI').textContent=allIndustries.size;
  document.getElementById('sC').textContent=allChannels.size;
  document.getElementById('sR').textContent=totalRows.toLocaleString();

  const main=document.getElementById('main');main.innerHTML='';

  for(const[cat,inds]of Object.entries(SUPER_CATEGORIES)){
    const avail=inds.filter(i=>allIndustries.has(i));
    if(!avail.length)continue;
    const sec=document.createElement('div');sec.className='super-cat';
    sec.innerHTML=`<div class="super-cat-hdr" onclick="toggleCat(this)"><span class="arr">&#9660;</span><h2>${cat}</h2><span class="cnt">${avail.length}</span></div><div class="grid" id="g-${cat.replace(/\W/g,'')}">${avail.map(i=>cardHTML(i)).join('')}</div>`;
    main.appendChild(sec);
  }
  requestAnimationFrame(()=>{for(const i of allIndustries)updateCard(i)});
}

function cardHTML(ind){
  const id=ind.replace(/\W/g,'');
  const chs=getChannelsFor(ind);
  const noUS=currentRegion==='us'&&!hasSegmentData(ind);
  const chText=chs.length?chs.slice(0,6).join(', ')+(chs.length>6?` +${chs.length-6} more`:''):'No data';

  return`<div class="card" id="c-${id}">
    <div class="card-top">
      <h3>${fmtInd(ind)}${noUS?'<span class="no-us">No segment data</span>':''}</h3>
      <div class="card-channels" id="cch-${id}">${chText}</div>
      <div class="metrics" id="met-${id}">
        <div class="metric" id="m-cpm-${id}"><div class="label">CPM</div><div class="val">—</div><div class="sub">Cost per 1K</div></div>
        <div class="metric" id="m-cpc-${id}"><div class="label">CPC</div><div class="val">—</div><div class="sub">Cost per Click</div></div>
        <div class="metric" id="m-ctr-${id}"><div class="label">CTR</div><div class="val">—</div><div class="sub">Click-through</div></div>
        <div class="metric" id="m-cpa-${id}"><div class="label">CPA</div><div class="val">—</div><div class="sub">Cost per Acq.</div></div>
        <div class="metric" id="m-roas-${id}"><div class="label">ROAS</div><div class="val">—</div><div class="sub">Return on Spend</div></div>
        <div class="metric" id="m-aov-${id}"><div class="label">AOV</div><div class="val">—</div><div class="sub">Avg. Order</div></div>
        <div class="metric" id="m-cvr-${id}"><div class="label">CVR</div><div class="val">—</div><div class="sub">Conversion</div></div>
        <div class="metric" id="m-mer-${id}"><div class="label">MER</div><div class="val">—</div><div class="sub">Efficiency</div></div>
      </div>
      <div class="spark-row">
        <div class="spark-box"><div class="spark-label">CPM Trend</div><canvas id="sp-cpm-${id}"></canvas></div>
        <div class="spark-box"><div class="spark-label">ROAS Trend</div><canvas id="sp-roas-${id}"></canvas></div>
      </div>
    </div>
    <button class="expand-btn" onclick="toggleDetail('${id}','${ind}')"><span id="exp-${id}">See More &#9660;</span></button>
    <div class="detail" id="det-${id}"></div>
  </div>`;
}

function updateCard(ind){
  const id=ind.replace(/\W/g,'');
  const m=getLatestMetrics(ind);

  setMetric(id,'cpm',m?.cpm,'$');
  setMetric(id,'cpc',m?.cpc,'$');
  setMetric(id,'ctr',m?.ctr,'%');
  setMetric(id,'cpa',m?.cpa,'$');
  setMetric(id,'roas',m?.roas,'x','roas');
  setMetric(id,'aov',m?.aov,'$');
  setMetric(id,'cvr',m?.cvr,'%');
  setMetric(id,'mer',m?.mer,'','mer');

  // Update channel list
  const chs=getChannelsFor(ind);
  const chEl=document.getElementById(`cch-${id}`);
  if(chEl) chEl.textContent=chs.length?chs.slice(0,6).join(', ')+(chs.length>6?` +${chs.length-6} more`:''):'No data';

  // Sparklines (global only since US is single snapshot)
  if(currentRegion==='global'){
    const cpmT=getGlobalMonthlyTrend(ind,'cpm',8);
    const roasT=getGlobalMonthlyTrend(ind,'roas',8);
    sparkline(`sp-cpm-${id}`,cpmT,'#3b82f6','$');
    sparkline(`sp-roas-${id}`,roasT,'#22c55e','');
  } else {
    // For US, show global trend as context
    const cpmT=getGlobalMonthlyTrend(ind,'cpm',8);
    const roasT=getGlobalMonthlyTrend(ind,'roas',8);
    sparkline(`sp-cpm-${id}`,cpmT,'#64748b','$');
    sparkline(`sp-roas-${id}`,roasT,'#64748b','');
  }

  // If detail open, refresh
  const det=document.getElementById(`det-${id}`);
  if(det&&det.classList.contains('open')) renderDetail(id,ind);
}

function setMetric(id,key,val,fmt_type,classKey){
  const el=document.getElementById(`m-${key}-${id}`);
  if(!el)return;
  el.querySelector('.val').textContent=fmt(val,fmt_type);
  el.className='metric '+(classKey?metricClass(classKey,val):'');
}

// =========== DETAIL ===========
function toggleDetail(id,ind){
  const det=document.getElementById(`det-${id}`);
  const exp=document.getElementById(`exp-${id}`);
  if(det.classList.contains('open')){det.classList.remove('open');exp.innerHTML='See More &#9660;'}
  else{det.classList.add('open');exp.innerHTML='See Less &#9650;';renderDetail(id,ind)}
}

function renderDetail(id,ind){
  const det=document.getElementById(`det-${id}`);
  const isUS=currentRegion==='us';

  // Per-channel breakdown table
  let rows='';
  if(isUS){
    const chs=usData[ind];
    if(chs){
      const filtered=filterChannels(chs);
      for(const[ch,m]of Object.entries(filtered).sort((a,b)=>a[0].localeCompare(b[0]))){
        const color=ALL_CHANNELS_COLOR[ch]||'#64748b';
        rows+=`<tr><td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin-right:6px"></span>${ch}</td><td>${fmt(m.cpm,'$')}</td><td>${fmt(m.cpc,'$')}</td><td>${fmt(m.ctr,'%')}</td><td>${fmt(m.cpa,'$')}</td><td>${fmt(m.cvr,'%')}</td><td>${fmt(m.roas,'x')}</td><td>${fmt(m.aov,'$')}</td><td>${fmt(m.mer,'')}</td></tr>`;
      }
    }
  } else {
    // Latest month per channel
    const chs=globalData[ind];
    if(chs){
      const filtered=filterChannels(chs);
      const months=new Set();
      for(const c in filtered)for(const m in filtered[c])months.add(m);
      const sorted=[...months].sort(sortM);
      const latest=sorted[sorted.length-1];
      for(const[ch,mData]of Object.entries(filtered).sort((a,b)=>a[0].localeCompare(b[0]))){
        const m=mData[latest];if(!m)continue;
        const color=ALL_CHANNELS_COLOR[ch]||'#64748b';
        rows+=`<tr><td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${color};margin-right:6px"></span>${ch}</td><td>${fmt(m.cpm,'$')}</td><td>${fmt(m.cpc,'$')}</td><td>${fmt(m.ctr,'%')}</td><td>${fmt(m.cpa,'$')}</td><td>${fmt(m.cvr,'%')}</td><td>${fmt(m.roas,'x')}</td><td>${fmt(m.aov,'$')}</td><td>${fmt(m.mer,'')}</td></tr>`;
      }
    }
  }

  const dowId=`dow-${id}`,womId=`wom-${id}`,domId=`dom-${id}`,trendId=`trend-${id}`;

  det.innerHTML=`
    <div class="detail-section">
      <h4>Channel Breakdown${isUS?' ($1M-$10M GMV Tier)':' (All Markets, Latest Month)'}</h4>
      ${rows?`<table class="tbl"><thead><tr><th>Channel</th><th>CPM</th><th>CPC</th><th>CTR</th><th>CPA</th><th>CVR</th><th>ROAS</th><th>AOV</th><th>MER</th></tr></thead><tbody>${rows}</tbody></table>`:'<div style="color:var(--text3);font-size:12px;padding:12px">No data for current selection</div>'}
    </div>
    ${!isUS?`<div class="detail-section"><h4>ROAS Trend (12 Months)</h4><div class="chart-box"><canvas id="${trendId}"></canvas></div></div>`:''}
    <div class="detail-section">
      <h4>Time Patterns (Global)</h4>
      <div class="chart-row">
        <div class="chart-box"><h5>CPA by Day of Week</h5><canvas id="${dowId}"></canvas></div>
        <div class="chart-box"><h5>CPA by Week of Month</h5><canvas id="${womId}"></canvas></div>
      </div>
      <div class="chart-row" style="margin-top:12px">
        <div class="chart-box" style="grid-column:1/-1"><h5>CPA by Day of Month (Days 10-16, partial)</h5><canvas id="${domId}"></canvas></div>
      </div>
    </div>`;

  requestAnimationFrame(()=>{
    if(!isUS){
      const roasT=getGlobalMonthlyTrend(ind,'roas',12);
      barChart(trendId,roasT.map(d=>d.month),roasT.map(d=>d.value),'#22c55e','x');
    }
    const dowK=['1','2','3','4','5','6','7'];
    const dowM=getTimeDim(dowData,ind,dowK);
    const dowV=dowM.map(m=>m?.cpa??null);
    if(dowV.some(v=>v!=null))barChart(dowId,DAY_NAMES,dowV,'#3b82f6','$');

    const womK=['1','2','3','4','5'];
    const womM=getTimeDim(womData,ind,womK);
    const womV=womM.map(m=>m?.cpa??null);
    if(womV.some(v=>v!=null))barChart(womId,['Wk 1','Wk 2','Wk 3','Wk 4','Wk 5'],womV,'#a78bfa','$');

    const domK=[];for(let d=10;d<=16;d++)domK.push(String(d));
    const domM=getTimeDim(domData,ind,domK);
    const domV=domM.map(m=>m?.cpa??null);
    if(domV.some(v=>v!=null))barChart(domId,domK.map(d=>'Day '+d),domV,'#f59e0b','$');
  });
}

// =========== CATEGORY TOGGLE ===========
function toggleCat(hdr){
  hdr.classList.toggle('collapsed');
  hdr.nextElementSibling.classList.toggle('hidden');
}

// =========== REGION TOGGLE ===========
document.getElementById('regionToggle').addEventListener('click',e=>{
  const btn=e.target.closest('.region-btn');if(!btn)return;
  document.querySelectorAll('.region-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentRegion=btn.dataset.region;
  render();
});

// =========== CHANNEL GROUP ===========
document.getElementById('chGroupBar').addEventListener('click',e=>{
  const btn=e.target.closest('.ch-group-btn');if(!btn)return;
  document.querySelectorAll('.ch-group-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  currentGroup=btn.dataset.group;
  selectedChannels.clear();
  renderSubChannels();
  refreshAllCards();
});

function renderSubChannels(){
  const sub=document.getElementById('chSubBar');
  if(currentGroup==='all'){sub.innerHTML='';return}
  const grp=CHANNEL_GROUPS[currentGroup];
  if(!grp){sub.innerHTML='';return}
  sub.innerHTML=grp.channels.map(ch=>{
    const col=grp.colors[ch]||'#666';
    const sel=selectedChannels.size===0||selectedChannels.has(ch);
    return`<button class="ch-sub-btn${sel?' selected':''}" style="background:${col}${sel?'':'44'};color:${sel?'#fff':'#999'}" data-ch="${ch}" onclick="toggleSubCh(this)">${ch}</button>`;
  }).join('');
}

function toggleSubCh(btn){
  const ch=btn.dataset.ch;
  const grp=CHANNEL_GROUPS[currentGroup];
  if(!grp)return;

  if(selectedChannels.size===0){
    // First click: select only this one
    selectedChannels.clear();
    selectedChannels.add(ch);
  } else if(selectedChannels.has(ch)){
    selectedChannels.delete(ch);
    if(selectedChannels.size===0){
      // Back to all selected
    }
  } else {
    selectedChannels.add(ch);
    // If all selected, clear (means all)
    if(selectedChannels.size===grp.channels.length) selectedChannels.clear();
  }
  renderSubChannels();
  refreshAllCards();
}

function refreshAllCards(){
  for(const i of allIndustries) updateCard(i);
}

// =========== SEARCH ===========
document.getElementById('searchInput').addEventListener('input',function(){
  const q=this.value.toLowerCase().trim();
  document.querySelectorAll('.super-cat').forEach(cat=>{
    const cards=cat.querySelectorAll('.card');
    let any=false;
    cards.forEach(c=>{
      const n=c.querySelector('h3').textContent.toLowerCase();
      const match=!q||n.includes(q);
      c.style.display=match?'':'none';
      if(match)any=true;
    });
    cat.style.display=any?'':'none';
    if(q&&any){
      cat.querySelector('.grid').classList.remove('hidden');
      cat.querySelector('.super-cat-hdr').classList.remove('collapsed');
    }
  });
});

// =========== INIT ===========
(async()=>{
  try{
    await loadAll();
    document.getElementById('loading').style.display='none';
    document.getElementById('main').style.display='block';
    render();
  }catch(err){
    document.getElementById('loading').innerHTML=`<div style="color:#ef4444">Error: ${err.message}<br><br>Serve via HTTP: python3 -m http.server 8765</div>`;
    console.error(err);
  }
})();
</script>
</body>
</html>
